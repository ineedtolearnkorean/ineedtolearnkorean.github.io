<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study World</title>
  <style>
    body{margin:0;background:#f7f7fb;font-family:system-ui;color:#111;}
    .top{
      position:sticky;top:0;background:#ffffffcc;backdrop-filter: blur(8px);
      border-bottom:1px solid #e8e8e8;padding:12px 14px;display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between; z-index:5;
    }
    .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .pill{padding:8px 10px;border:1px solid #e6e6e6;border-radius:999px;background:#fff;font-size:13px;}
    .wrap{padding:14px;max-width:900px;margin:0 auto;}
    canvas{width:100%;height:auto;border-radius:16px;border:1px solid #e8e8e8;background:#fff;}
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:16px;padding:14px;margin-top:12px;}
    button{border:1px solid #ddd;background:#fff;border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .small{font-size:12px;color:#666;line-height:1.35}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:10;
    }
    .modal{
      width:min(760px, 100%); background:#fff; border-radius:18px; border:1px solid #e8e8e8;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .modalTop{
      padding:14px 16px; border-bottom:1px solid #eee;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#ffffffcc; backdrop-filter: blur(8px);
    }
    .modalBody{padding:14px 16px;}
    .charRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .avatar{
      width:62px; height:62px; border-radius:16px; border:1px solid #e6e6e6; background:#fff;
      display:flex; align-items:center; justify-content:center; font-size:26px;
      flex:0 0 auto;
    }
    .name{font-weight:900;font-size:16px;}
    .tag{font-size:12px;color:#666;margin-top:2px;}
    .meter{
      height:10px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px;
      border:1px solid #e6e6e6; width:min(520px, 100%);
    }
    .meter > div{height:10px; background:#111; width:0%;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
    .log{
      background:#f3f3f3; border:1px solid #e8e8e8; border-radius:14px;
      padding:10px 12px; font-size:13px; line-height:1.45; margin-top:12px;
      white-space:pre-wrap;
    }
    .divider{height:1px;background:#eee;margin:14px 0;}
  </style>
</head>
<body>

<div class="top">
  <div><b>Study World</b> <span class="small">tap objects in the room</span></div>
  <div class="stats">
    <div class="pill">Level: <b id="lvl">1</b></div>
    <div class="pill">XP: <b id="xp">0</b>/<span id="xpNext">100</span></div>
    <div class="pill">Coins: <b id="coins">0</b></div>
    <div class="pill">Mode: <b id="modeText">day</b></div>
  </div>
</div>

<div class="wrap">
  <canvas id="c" width="900" height="520"></canvas>

  <div class="card">
    <div class="row">
      <button id="claimBtn">Claim daily reward</button>
      <button id="modeBtn">Toggle Day/Night</button>
      <button id="shopBtn">Shop</button>
      <button id="resetBtn">Reset progress</button>
    </div>

    <p class="small" id="msg">
      Tip: Tap Desk / Headphones / Keyboard / Hangout. Your progress saves automatically.
    </p>

    <p class="small">
      This world expects these folders in your repo:
      <br>• <code>sentence-builder/index.html</code>
      <br>• <code>listening-quiz/index.html</code>
      <br>• <code>speed-typing/index.html</code>
      <br>• <code>study-world/index.html</code>
    </p>
  </div>
</div>

<!-- Dating Modal -->
<div class="modalBack" id="datingBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalTop">
      <div><b>Hangout</b></div>
      <button id="closeDatingBtn">Close</button>
    </div>
    <div class="modalBody">
      <div class="charRow">
        <div class="avatar" id="partnerAvatar">☕</div>
        <div>
          <div class="name" id="partnerName">민준</div>
          <div class="tag" id="partnerTag">조용한데 다정한 타입</div>
          <div class="small" style="margin-top:6px;">
            호감도: <b id="affText">0</b> / <span id="affMax">60</span> · 단계: <b id="stageText">0</b>
          </div>
          <div class="meter"><div id="affBar"></div></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="small">
        아래 선택지는 전부 한국어로만 진행돼요.
      </div>

      <div class="btns">
        <button id="btnCompliment">칭찬하기 (+3)</button>
        <button id="btnDay">오늘 어땠어? (+2)</button>
        <button id="btnFlirt">플러팅 (성공 +5 / 실패 -3)</button>
        <button id="btnDate">데이트</button>
      </div>

      <div class="log" id="datingLog">…</div>
    </div>
  </div>
</div>

<script>
/* =======================
   Save data
======================= */
const KEY = "study_world_v3_one_partner";
const todayKey = () => new Date().toISOString().slice(0,10);
function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

const state = load() || {
  level: 1,
  xp: 0,
  coins: 0,
  dailyClaim: "",
  mode: "day",
  items: { plant:false, poster:false, lamp:false },

  // One relationship
  partner: {
    name: "민준",
    vibe: "조용한데 다정한 타입",
    avatar: "☕",
    affection: 0,     // 0..60
    stage: 0,         // 0..3
    lastDate: ""      // YYYY-MM-DD
  }
};
save();

function xpNeeded(level){ return 80 + (level-1)*30; }

function toast(text){
  document.getElementById("msg").textContent = text;
}

function renderHUD(){
  document.getElementById("lvl").textContent = state.level;
  document.getElementById("xp").textContent = state.xp;
  document.getElementById("xpNext").textContent = xpNeeded(state.level);
  document.getElementById("coins").textContent = state.coins;
  document.getElementById("modeText").textContent = state.mode;
}
renderHUD();

function addRewards(xpGain, coinGain){
  state.xp += xpGain;
  state.coins += coinGain;

  while(state.xp >= xpNeeded(state.level)){
    state.xp -= xpNeeded(state.level);
    state.level += 1;
    toast(`Level up! Now level ${state.level}.`);
  }

  save();
  renderHUD();
  draw();
}

/* =======================
   Canvas room
======================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function roundRect(x,y,w,h,r,fill,stroke){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  ctx.fillStyle=fill; ctx.fill();
  ctx.strokeStyle=stroke; ctx.lineWidth=3; ctx.stroke();
}
function drawLabel(o, text){
  ctx.font="600 14px system-ui";
  ctx.fillStyle = (state.mode==="night") ? "#f0f0f0" : "#111";
  ctx.fillText(text, o.x, o.y-10);
}
function book(x,y,w,h,color){
  roundRect(x,y,w,h,8,color,"#ffffff");
}
function drawAvatarBlob(x,y){
  // shadow
  ctx.globalAlpha=0.18; ctx.fillStyle="#000";
  ctx.beginPath(); ctx.ellipse(x+60,y+110,55,14,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // body
  roundRect(x, y+30, 120, 110, 40, "#ffffff", "#e6e6e6");

  // face
  ctx.fillStyle="#111";
  ctx.beginPath(); ctx.arc(x+45,y+70,4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x+80,y+70,4,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle="#111"; ctx.lineWidth=3;
  ctx.beginPath(); ctx.arc(x+62,y+84,16,0.2*Math.PI,0.8*Math.PI); ctx.stroke();

  // tiny book
  roundRect(x+88,y+92,26,18,6,"#d9f6ff","#89d3e6");
}

const obj = {
  desk: {
    x: 300, y: 240, w: 280, h: 150,
    draw(){
      roundRect(this.x,this.y+40,this.w,40,18,"#ffe1b5","#f2b66f");
      roundRect(this.x+30,this.y+80,36,95,14,"#ffd29a","#f2b66f");
      roundRect(this.x+this.w-66,this.y+80,36,95,14,"#ffd29a","#f2b66f");
      roundRect(this.x+110,this.y+10,70,50,12,"#eaeaea","#cfcfcf");
      roundRect(this.x+105,this.y+55,80,14,10,"#d7d7d7","#cfcfcf");
      roundRect(this.x+210,this.y+20,38,30,8,"#fff3a8","#e5d46c");
    },
    action(){ openGame("Desk: Sentence Builder", "../sentence-builder/"); }
  },
  headphones: {
    x: 120, y: 240, w: 150, h: 160,
    draw(){
      roundRect(this.x+60,this.y+70,30,110,14,"#ffffff","#e6e6e6");
      roundRect(this.x+30,this.y+170,90,20,12,"#ffffff","#e6e6e6");
      ctx.strokeStyle="#111"; ctx.lineWidth=8;
      ctx.beginPath(); ctx.arc(this.x+75,this.y+70,45,Math.PI,0); ctx.stroke();
      roundRect(this.x+25,this.y+70,30,55,12,"#111","#111");
      roundRect(this.x+95,this.y+70,30,55,12,"#111","#111");
    },
    action(){ openGame("Headphones: Listening Quiz", "../listening-quiz/"); }
  },
  bookshelf: {
    x: 610, y: 180, w: 220, h: 210,
    draw(){
      roundRect(this.x,this.y,this.w,this.h,18,"#e8fff0","#8de0b0");
      ctx.fillStyle="#8de0b0";
      ctx.fillRect(this.x+14,this.y+70,this.w-28,10);
      ctx.fillRect(this.x+14,this.y+130,this.w-28,10);

      book(this.x+25,this.y+20,18,42,"#ffb3c7");
      book(this.x+47,this.y+20,18,42,"#b3d9ff");
      book(this.x+69,this.y+20,18,42,"#fff3a8");
      book(this.x+25,this.y+80,22,46,"#c7b3ff");
      book(this.x+50,this.y+80,22,46,"#ffd29a");
      book(this.x+75,this.y+80,22,46,"#b3ffd6");

      roundRect(this.x+125,this.y+145,78,30,10,"#ffffff","#e6e6e6");
      ctx.fillStyle="#cfcfcf";
      for(let i=0;i<6;i++) ctx.fillRect(this.x+132+i*12,this.y+152,8,6);
    },
    action(){ openGame("Keyboard: Speed Typing", "../speed-typing/"); }
  },
  hangout: {
    x: 70, y: 160, w: 220, h: 210,
    draw(){
      // small cafe corner + partner blob
      roundRect(this.x+18,this.y+120,160,70,18,"#ffffff","#e6e6e6"); // table
      roundRect(this.x+45,this.y+40,80,110,38,"#ffffff","#e6e6e6"); // partner body
      ctx.fillStyle="#111";
      ctx.beginPath(); ctx.arc(this.x+75,this.y+82,4,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(this.x+98,this.y+82,4,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle="#111"; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(this.x+86,this.y+98,16,0.2*Math.PI,0.8*Math.PI); ctx.stroke();

      // little heart bubble
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "#ff6fa3";
      ctx.beginPath(); ctx.arc(this.x+155,this.y+55,10,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;

      // coffee cup icon
      ctx.fillStyle="#111";
      ctx.font="700 18px system-ui";
      ctx.fillText("☕", this.x+132, this.y+155);
    },
    action(){ openDating(); }
  }
};

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const isNight = state.mode === "night";

  // wall
  ctx.fillStyle = isNight ? "#1b1630" : "#fdf6ff";
  ctx.fillRect(0,0,900,340);

  // floor
  ctx.fillStyle = isNight ? "#2a2346" : "#ffeecf";
  ctx.fillRect(0,340,900,180);

  if(isNight){
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,900,520);
    ctx.globalAlpha = 1;
  }

  // window
  roundRect(60,60,180,120,18, isNight ? "#2b3a68" : "#cfe9ff", isNight ? "#4456a6" : "#9cc9ff");
  ctx.fillStyle = isNight ? "#233055" : "#bfe1ff";
  ctx.fillRect(75,75,70,45);
  ctx.fillRect(150,75,70,45);
  ctx.fillRect(75,125,70,45);
  ctx.fillRect(150,125,70,45);

  // rug
  roundRect(260,380,380,100,30, isNight ? "#3a2b55" : "#ffd7e5", isNight ? "#6b5aa6" : "#f1a3bf");
  ctx.fillStyle="#fff";
  ctx.globalAlpha=0.22;
  ctx.beginPath(); ctx.ellipse(450,430,160,40,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // objects
  obj.bookshelf.draw();
  obj.desk.draw();
  obj.headphones.draw();
  obj.hangout.draw();

  // player avatar
  drawAvatarBlob(700,365);

  // labels
  drawLabel(obj.desk, "Desk");
  drawLabel(obj.headphones, "Headphones");
  drawLabel(obj.bookshelf, "Keyboard");
  drawLabel(obj.hangout, "Hangout");

  // decor unlocks
  if(state.items.poster){
    roundRect(320,70,140,90,16,"#fff","#e6e6e6");
    ctx.fillStyle = isNight ? "#c7b3ff" : "#ff6fa3";
    ctx.font = "800 20px system-ui";
    ctx.fillText("STUDY", 360, 120);
    ctx.font = "600 12px system-ui";
    ctx.fillStyle = isNight ? "#f0f0f0" : "#111";
    ctx.fillText("one more round", 350, 145);
  }

  if(state.items.plant){
    roundRect(520,300,60,60,16,"#fff","#e6e6e6");
    ctx.fillStyle="#4caf50";
    ctx.beginPath(); ctx.arc(550,300,26,0,Math.PI*2); ctx.fill();
  }

  if(state.items.lamp){
    roundRect(240,250,40,90,16,"#fff","#e6e6e6");
    ctx.fillStyle="#ffd29a";
    ctx.beginPath(); ctx.ellipse(260,250,34,18,0,0,Math.PI*2); ctx.fill();

    if(isNight){
      ctx.globalAlpha=0.18;
      ctx.fillStyle="#ffd29a";
      ctx.beginPath(); ctx.ellipse(260,260,130,90,0,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1;
    }
  }
}
draw();

function openGame(title, url){
  const ok = confirm(`${title}\n\nOpen now?`);
  if(ok) location.href = url;
}

canvas.addEventListener("click",(e)=>{
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * (canvas.width / r.width);
  const y = (e.clientY - r.top) * (canvas.height / r.height);

  for(const k of Object.keys(obj)){
    const o = obj[k];
    if(x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h){
      o.action();
      return;
    }
  }
});

/* =======================
   Buttons (world)
======================= */
document.getElementById("claimBtn").onclick = ()=>{
  if(state.dailyClaim === todayKey()){
    toast("Daily reward already claimed today.");
    return;
  }
  state.dailyClaim = todayKey();
  save();
  addRewards(20, 15);
  toast("Daily reward claimed: +20 XP, +15 coins.");
};

document.getElementById("modeBtn").onclick = ()=>{
  state.mode = (state.mode === "day") ? "night" : "day";
  save();
  renderHUD();
  draw();
  toast("Mode: " + state.mode);
};

document.getElementById("shopBtn").onclick = ()=>{
  const prices = { plant: 30, poster: 45, lamp: 60 };
  const owned = state.items;

  const menu =
`SHOP (coins: ${state.coins})

1) Plant (${prices.plant}) ${owned.plant ? "owned" : ""}
2) Poster (${prices.poster}) ${owned.poster ? "owned" : ""}
3) Lamp (${prices.lamp}) ${owned.lamp ? "owned" : ""}

Type: plant / poster / lamp`;

  const choice = prompt(menu, "");
  if(!choice) return;

  const key = choice.trim().toLowerCase();
  if(!(key in prices)){ toast("Not a valid item."); return; }
  if(owned[key]){ toast("You already own that."); return; }
  if(state.coins < prices[key]){ toast("Not enough coins yet."); return; }

  state.coins -= prices[key];
  state.items[key] = true;
  save();
  renderHUD();
  draw();
  toast("Bought: " + key + "!");
};

document.getElementById("resetBtn").onclick = ()=>{
  const ok = confirm("Reset your Study World progress?");
  if(!ok) return;
  localStorage.removeItem(KEY);
  location.reload();
};

/* =======================
   Dating (one partner, Korean-only)
======================= */
const datingBack = document.getElementById("datingBack");
const closeDatingBtn = document.getElementById("closeDatingBtn");
const partnerNameEl = document.getElementById("partnerName");
const partnerTagEl = document.getElementById("partnerTag");
const partnerAvatarEl = document.getElementById("partnerAvatar");
const affTextEl = document.getElementById("affText");
const affMaxEl = document.getElementById("affMax");
const stageTextEl = document.getElementById("stageText");
const affBarEl = document.getElementById("affBar");
const logEl = document.getElementById("datingLog");

const AFF_MAX = 60;

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function datingUI(){
  const p = state.partner;
  partnerNameEl.textContent = p.name;
  partnerTagEl.textContent = p.vibe;
  partnerAvatarEl.textContent = p.avatar;

  affTextEl.textContent = String(p.affection);
  affMaxEl.textContent = String(AFF_MAX);
  stageTextEl.textContent = String(p.stage);

  const pct = (p.affection / AFF_MAX) * 100;
  affBarEl.style.width = pct + "%";
}

function openDating(){
  datingUI();
  logEl.textContent = introLine();
  datingBack.style.display = "flex";
}

closeDatingBtn.onclick = ()=> datingBack.style.display = "none";
datingBack.addEventListener("click",(e)=>{
  if(e.target === datingBack) datingBack.style.display = "none";
});

function introLine(){
  const p = state.partner;
  if(p.stage === 0) return "민준: 어… 왔어? 오늘도 공부했어?";
  if(p.stage === 1) return "민준: 요즘 네가 오는 게… 은근히 기다려져.";
  if(p.stage === 2) return "민준: 오늘은 같이 좀 걸을래? 얘기하고 싶어.";
  return "민준: 너랑 있으면 마음이 편해. 고마워.";
}

function updateStage(){
  const p = state.partner;
  // unlock thresholds
  if(p.affection >= 45) p.stage = Math.max(p.stage, 3);
  else if(p.affection >= 25) p.stage = Math.max(p.stage, 2);
  else if(p.affection >= 10) p.stage = Math.max(p.stage, 1);
}

function addAffection(delta, line){
  const p = state.partner;
  p.affection = clamp(p.affection + delta, 0, AFF_MAX);
  updateStage();
  save();
  datingUI();
  logEl.textContent = line;
}

function canDate(){
  return state.partner.affection >= 10;
}

function dateOptions(){
  const a = state.partner.affection;
  // unlocked by affection
  if(a >= 45) return ["카페", "서점", "산책"];
  if(a >= 25) return ["카페", "산책"];
  return ["카페"];
}

function startDate(){
  if(!canDate()){
    logEl.textContent = "민준: 아직은… 천천히 알아가자.";
    return;
  }

  const opts = dateOptions();
  const pick = prompt(`데이트 선택: ${opts.join(" / ")}`, opts[0]);
  if(!pick) return;

  const choice = pick.trim();
  if(!opts.includes(choice)){
    logEl.textContent = "민준: 그건… 아직은 좀 부담스럽다.";
    return;
  }

  // Rewards from dates
  const xp = (choice === "서점") ? 25 : 15;
  const coins = 10;

  // Dating dialogue in Korean only
  let line = "";
  if(choice === "카페"){
    line = "민준: 따뜻한 거 마실래? 네 취향이 궁금해.";
  } else if(choice === "서점"){
    line = "민준: 너랑 서점 오면… 시간 가는 줄 모르겠어.";
  } else {
    line = "민준: 오늘 공기 좋다. 너랑 걸으니까 더 좋네.";
  }

  // affection bump
  state.partner.lastDate = todayKey();
  addRewards(xp, coins);
  addAffection(4, line + `\n(보상: XP +${xp}, Coins +${coins}, 호감도 +4)`);
}

/* Buttons inside modal */
document.getElementById("btnCompliment").onclick = ()=>{
  const lines = [
    "너 오늘 스타일 진짜 잘 어울린다.",
    "말투가 부드러워서 듣기 좋아.",
    "너랑 있으면 마음이 편해."
  ];
  const l = lines[Math.floor(Math.random()*lines.length)];
  addAffection(3, `나: ${l}\n민준: …고마워. 괜히 설렌다.`);
};

document.getElementById("btnDay").onclick = ()=>{
  const lines = [
    "오늘 하루 어땠어?",
    "요즘 뭐가 제일 재밌어?",
    "요즘 제일 힘든 건 뭐야?"
  ];
  const l = lines[Math.floor(Math.random()*lines.length)];
  addAffection(2, `나: ${l}\n민준: 그냥 평범했는데… 너 만나니까 좀 좋아졌어.`);
};

document.getElementById("btnFlirt").onclick = ()=>{
  // 60% success
  const success = Math.random() < 0.6;
  if(success){
    addAffection(5, "나: 너랑 데이트하면… 나 진짜 설렐 것 같아.\n민준: …그 말, 책임져. (웃음)");
  } else {
    addAffection(-3, "나: 너 오늘… 귀엽다.\n민준: 어… 갑자기? (당황)\n(분위기 조금 어색해졌다.)");
  }
};

document.getElementById("btnDate").onclick = ()=>{
  startDate();
};
</script>

</body>
</html>
