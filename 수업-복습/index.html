<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ì—… ë³µìŠµ</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --card2:#f1f2f7;
      --text:#111827;
      --muted:#4b5563;
      --line:#e5e7eb;
      --accent:#7c3aed;
      --accentSoft:rgba(124,58,237,0.12);
      --good:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
      line-height:1.65;
      font-size:16px;
    }
    header{
      padding:18px 16px 12px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background:rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    header h1{margin:0;font-size:22px;letter-spacing:.2px}
    header .sub{
      margin-top:8px;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 60px;}
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:12px 0 14px;
    }
    .tabBtn{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:650;
    }
    .tabBtn.active{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 4px rgba(124,58,237,.13);
      background:#fff;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){
      .grid.two{grid-template-columns:1.2fr .8fr;}
    }

    .sectionTitle{
      font-size:22px;
      margin:0 0 6px;
      color:var(--text);
    }
    .muted{color:var(--muted);font-size:15px}
    .en{display:block;color:var(--muted);font-size:13px;margin-top:2px}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}
    .pill{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid var(--line);
      background:var(--accentSoft);
      padding:12px 14px;
      border-radius:14px;
      margin:10px 0 0;
      font-size:14px;
      line-height:1.45;
    }
    .pill strong{color:#3b2a86}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.65);
    }
    .item h4{
      margin:0 0 8px;
      font-size:20px;
      font-weight:750;
      color:var(--text);
    }
    .item p{margin:6px 0 0;color:var(--muted);font-size:15px;line-height:1.5}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:650;
    }
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}
    .btn.primary{
      border-color:rgba(22,163,74,.40);
      box-shadow:0 0 0 3px rgba(22,163,74,.10);
      background:#f3faf6;
    }
    .btn.accent{
      border-color:rgba(124,58,237,.35);
      box-shadow:0 0 0 3px rgba(124,58,237,.10);
      background:#faf7ff;
    }
    .btn.danger{
      border-color:rgba(220,38,38,.40);
      box-shadow:0 0 0 3px rgba(220,38,38,.08);
      background:#fff5f5;
    }
    .btn:active{transform:translateY(1px)}
    details summary{
      cursor:pointer;
      color:#3b2a86;
      font-size:14px;
      list-style:none;
      user-select:none;
      font-weight:700;
    }
    details summary::-webkit-details-marker{display:none}
    details .answer{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      background:var(--accentSoft);
      border:1px solid rgba(124,58,237,.18);
      font-size:15px;
      line-height:1.55;
      color:var(--text);
    }

    textarea,input[type="text"]{
      width:100%;
      padding:16px;
      border-radius:16px;
      border:2px solid #c7d2fe;
      background:#ffffff;
      color:#111827;
      font-size:16px;
      outline:none;
      box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    textarea{min-height:140px;resize:vertical}
    textarea:focus,input[type="text"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(124,58,237,0.15);
    }

    .statusLine{margin-top:10px;font-size:14px;color:var(--muted);line-height:1.5}
    .ok{color:var(--good);font-weight:750}
    .bad{color:var(--bad);font-weight:750}
    .warn{color:var(--warn);font-weight:750}
    .tiny{font-size:12px;color:var(--muted)}
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;padding:2px 7px;border:1px solid var(--line);
      border-radius:9px;background:#fff;color:var(--muted);
    }
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .select{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      outline:none;
      font-weight:650;
    }
    .progressRow{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .progressBox{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:var(--muted);
    }
    .chip{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      font-weight:650;
    }
    .chip.active{
      border-color:rgba(124,58,237,.55);
      box-shadow:0 0 0 3px rgba(124,58,237,.12);
      background:#faf7ff;
    }
  </style>
</head>

<body>
<header>
  <h1>ìˆ˜ì—… ë³µìŠµ</h1>
  <div class="sub">
    <span class="badge" id="badgeLesson">Lesson: 2.4 & 2.11</span>
    <span class="badge" id="badgeGrammar">Target: ~ë‹¤ ë³´ë©´</span>
    <span class="badge">Flow: ì›Œë°ì—… â†’ ë²ˆì—­ â†’ ë¬¸ì¥ â†’ ì½ê¸°/ê²Œì„ â†’ SRS</span>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tabBtn active" data-tab="warmup">ë‹¨ì–´ ì›Œë°ì—…</button>
    <button class="tabBtn" data-tab="translate">ë²ˆì—­ ì—°ìŠµ</button>
    <button class="tabBtn" data-tab="builder">ë¬¸ì¥ ë§Œë“¤ê¸°</button>
    <button class="tabBtn" data-tab="reading">ì½ê¸° + ì§ˆë¬¸</button>
    <button class="tabBtn" data-tab="games">ê²Œì„</button>
    <button class="tabBtn" data-tab="srs">í‹€ë¦° ê²ƒ ë³µìŠµ (SRS)</button>
    <button class="tabBtn" data-tab="settings">ì˜µì…˜</button>
  </div>

  <!-- TAB: Warm-up -->
  <section id="tab-warmup" class="tab">
    <div class="grid two">
      <div class="card">
        <div class="split">
          <div>
            <h3 class="sectionTitle">ğŸ§  ë‹¨ì–´ ì›Œë°ì—…</h3>
            <p class="muted">ë¨¼ì € ë‹¨ì–´ â€œì–¼êµ´ ìµíˆê¸°â€ + ê°€ë²¼ìš´ ì„ íƒ ë¬¸ì œ<span class="en">Warm up with recognition before producing sentences.</span></p>
          </div>
          <div class="tiny">
            ë‹¨ì¶•í‚¤: <span class="kbd">1</span> ì›Œë°ì—… / <span class="kbd">2</span> ë²ˆì—­ / <span class="kbd">3</span> ë¬¸ì¥ /
            <span class="kbd">4</span> ì½ê¸° / <span class="kbd">5</span> ê²Œì„ / <span class="kbd">6</span> SRS / <span class="kbd">7</span> ì˜µì…˜
          </div>
        </div>

        <div class="pill">
          <div>
            <strong>Tip</strong><br>
            ì—¬ê¸°ì„œëŠ” â€œì™„ë²½ ì•”ê¸°â€ ê¸ˆì§€. ê·¸ëƒ¥ ì¸ì§€ë§Œ í•˜ê³  ë‹¤ìŒ íƒ­ìœ¼ë¡œ ê°€ë©´ ë¼ìš”.<br>
            <span class="en">No perfection hereâ€”just recognize, then move on.</span>
          </div>
        </div>

        <hr>

        <div class="list" id="warmupList"></div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">ğŸ“Œ ì˜¤ëŠ˜ì˜ ë‹¨ì–´</h3>
        <p class="muted">Lesson Word Bank + Knowt Review (ì„ì–´ì„œ ë³´ì—¬ì¤˜ìš”)<span class="en">Lesson bank + Knowt review mixed together.</span></p>
        <hr>
        <div id="vocabPreview" class="muted"></div>
        <div class="row">
          <button class="btn small" id="shuffleVocab">ë‹¨ì–´ ì„ê¸°</button>
          <button class="btn small" id="copyVocab">ë‹¨ì–´ ë³µì‚¬</button>
          <button class="btn small accent" id="pick3Words">ì˜¤ëŠ˜ 3ë‹¨ì–´ ë½‘ê¸°</button>
        </div>
        <div class="statusLine" id="pickedWordsLine"></div>
      </div>
    </div>
  </section>

  <!-- TAB: Translation Practice -->
  <section id="tab-translate" class="tab" style="display:none;">
    <div class="card">

      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸŒ‰ ë²ˆì—­ ì—°ìŠµ</h3>
          <p class="muted">ì˜ì–´ â†’ í•œêµ­ì–´. ëª©í‘œ ë¬¸ë²• <b id="grammarInline">~ë‹¤ ë³´ë©´</b>ì€ ê¼­ í¬í•¨.<span class="en">English â†’ Korean. Include the target grammar.</span></p>
        </div>
        <div class="row" style="margin:0">
          <select id="filterLevel" class="select" aria-label="filter">
            <option value="ALL">ì „ì²´</option>
            <option value="Warm-up">Warm-up</option>
            <option value="Core">Core</option>
            <option value="Challenge">Challenge</option>
            <option value="Generated">Generated</option>
          </select>
        </div>
      </div>

      <div class="pill">
        <div>
          <strong>Meaning</strong><br>
          ê³„ì† Xë¥¼ í•˜ë‹¤ ë³´ë©´ ìì—°ìŠ¤ëŸ½ê²Œ Yê°€ ìƒê²¨ìš”/ë‹¬ë¼ì ¸ìš”.<br>
          <span class="en">If you keep doing X, Y naturally happens.</span>
        </div>
      </div>

      <hr>

      <!-- NEW: Generator -->
      <div class="item">
        <h4>âœ¨ ìë™ ìƒì„± ë²ˆì—­ ì—°ìŠµ</h4>
        <p class="muted">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒˆ ë¬¸ì¥ì´ ìƒì„±ë¼ìš” (ë‹¨ì–´ë±…í¬ íŒíŠ¸ í¬í•¨).<span class="en">Generate a new prompt with word-bank hints.</span></p>

        <div class="row">
          <button class="btn primary" id="genTranslation">New sentence</button>
          <button class="btn accent" id="genHint">Hint</button>
          <button class="btn" id="revealModel">Show model answer</button>
          <button class="btn danger" id="saveGenWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
        </div>

        <div style="margin-top:12px">
          <div class="badge" id="genMeta">â€”</div>
          <p style="margin:10px 0 6px"><b>English:</b> <span id="genEN">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘!</span></p>
          <p style="margin:0 0 10px"><b>Word bank hints:</b> <span id="genHints">â€”</span></p>

          <textarea id="genUserKO" placeholder="ì—¬ê¸°ì— í•œêµ­ì–´ ë²ˆì—­ì„ ì…ë ¥í•˜ì„¸ìš”. / Type your Korean translation here."></textarea>

          <details id="modelWrap" style="margin-top:10px">
            <summary>Model answer</summary>
            <div class="answer" id="genModelKO">â€”</div>
          </details>

          <div class="statusLine" id="genFeedback"></div>
        </div>
      </div>

      <hr>

      <div class="list" id="translationList"></div>
      <p class="muted" id="translationCount"></p>
    </div>
  </section>

  <!-- TAB: Sentence Builder -->
  <section id="tab-builder" class="tab" style="display:none;">
    <div class="card">
      <h3 class="sectionTitle">âœï¸ ë¬¸ì¥ ë§Œë“¤ê¸°</h3>
      <p class="muted">
        ëª©í‘œ: <b id="grammarInline2">~ë‹¤ ë³´ë©´</b> + ë‹¨ì–´ <b>3ê°œ ì´ìƒ</b> í¬í•¨í•´ì„œ ë‚´ ë¬¸ì¥ ë§Œë“¤ê¸°.
        <span class="en">Goal: include target grammar + 3+ words from today's bank.</span>
      </p>

      <hr>

      <div class="item">
        <h4>í…œí”Œë¦¿</h4>
        <p class="muted">Xí•˜ë‹¤ ë³´ë©´ Y(ì´/ê°€) ë‹¬ë¼ì ¸ìš” / ìƒê²¨ìš” / ì¢‹ì•„ì ¸ìš” / ëŠ˜ì–´ìš”<span class="en">Template: If you keep doing X, Y changes/appears/improves.</span></p>
        <div class="row">
          <button class="btn small" id="insertTemplate">í…œí”Œë¦¿ ë„£ê¸°</button>
          <button class="btn small" id="insertIdea">ëœë¤ ì•„ì´ë””ì–´</button>
          <button class="btn small accent" id="usePickedWords">ë½‘ì€ 3ë‹¨ì–´ë¡œ íŒíŠ¸</button>
        </div>
        <p class="tiny" id="ideaLine"></p>
      </div>

      <div class="item">
        <h4>âœï¸ ì—¬ê¸°ì—ì„œ ë¬¸ì¥ ì…ë ¥</h4>
        <p class="muted">~ë‹¤ ë³´ë©´ + ë‹¨ì–´ 3ê°œ ì´ìƒ ì‚¬ìš©<span class="en">Type your sentence here.</span></p>

        <textarea id="userSentence" placeholder="ì˜ˆ: í•¸ë“œí° ì‚¬ìš©ì„ ì¤„ì´ë‹¤ ë³´ë©´ ì—¬ìœ  ì‹œê°„ì´ ìƒê²¨ìš”."></textarea>

        <div class="row">
          <button class="btn primary" id="checkSentence">Check</button>
          <button class="btn danger" id="markSentenceWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          <button class="btn" id="clearSentence">ì§€ìš°ê¸°</button>
        </div>

        <div class="statusLine" id="sentenceFeedback"></div>
      </div>

      <div class="item">
        <h4>ë¬¸ì¥ ì²´í¬ ê·œì¹™(ìë™)</h4>
        <p class="muted">
          â€¢ ë¬¸ë²• í¬í•¨: <b>~ë‹¤ ë³´ë©´</b><br>
          â€¢ ë‹¨ì–´ 3ê°œ ì´ìƒ í¬í•¨(ì˜¤ëŠ˜ ë‹¨ì–´ ëª©ë¡ ê¸°ì¤€)<br>
          â€¢ í‹€ë¦¼ ì €ì¥í•˜ë©´ SRS íƒ­ì—ì„œ ë°˜ë³µ
          <span class="en">Auto-check: grammar + 3+ vocab hits; save mistakes to SRS.</span>
        </p>
      </div>
    </div>
  </section>

  <!-- TAB: Reading + Questions -->
  <section id="tab-reading" class="tab" style="display:none;">
    <div class="card">
      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸ“– ì½ê¸° + ì§ˆë¬¸</h3>
          <p class="muted">ì§§ì€ ì´ì•¼ê¸° ì½ê³  ì§ˆë¬¸ì— ë‹µí•´ìš” (ë‹¨ì–´/ë¬¸ë²• ìì—°ìŠ¤ëŸ½ê²Œ ë…¸ì¶œ).<span class="en">Read a short story and answer questions.</span></p>
        </div>
        <div class="row" style="margin:0">
          <button class="btn accent" id="newStory">ìƒˆ ì´ì•¼ê¸°</button>
          <button class="btn" id="toggleGloss">ë‹¨ì–´ íŒíŠ¸ í† ê¸€</button>
          <button class="btn danger" id="saveReadingWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
        </div>
      </div>

      <hr>

      <div class="item">
        <h4 id="storyTitle">ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°</h4>
        <p class="muted" id="storyKorean"></p>
        <p class="muted en" id="storyEnglish"></p>

        <details id="glossWrap" style="margin-top:10px">
          <summary>ë‹¨ì–´ íŒíŠ¸ / Vocab hints</summary>
          <div class="answer" id="storyGloss">â€”</div>
        </details>
      </div>

      <div class="item">
        <h4>ì§ˆë¬¸ / Questions</h4>
        <div id="readingQs"></div>

        <div class="row">
          <button class="btn primary" id="checkReading">Check answers</button>
        </div>
        <div class="statusLine" id="readingFeedback"></div>
      </div>
    </div>
  </section>

  <!-- TAB: Games -->
  <section id="tab-games" class="tab" style="display:none;">
    <div class="card">
      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸ® ê²Œì„</h3>
          <p class="muted">ë‘ë‡Œì— â€œì¬ë¯¸ ë²„íŠ¼â€ ëˆŒëŸ¬ì„œ ì•”ê¸° ë” ì˜ ë˜ê²Œ ğŸ™‚<span class="en">Fun mini-games for memory and retrieval.</span></p>
        </div>
        <div class="row" style="margin:0">
          <span class="chip active" data-game="rapid">ë¹ ë¥¸ ëœ» ë§íˆê¸°</span>
          <span class="chip" data-game="cloze">ë¹ˆì¹¸ ì±„ìš°ê¸°</span>
          <span class="chip" data-game="memory">ë©”ëª¨ë¦¬(í”Œë¦½)</span>
        </div>
      </div>

      <hr>

      <!-- Game: Rapid -->
      <div id="game-rapid" class="gamePane">
        <div class="item">
          <h4>âš¡ ë¹ ë¥¸ ëœ» ë§íˆê¸°</h4>
          <p class="muted">ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ ê³ ë¥´ê¸° (ë¹ ë¥´ê²Œ).<span class="en">Pick the correct meaning quickly.</span></p>

          <div class="pill">
            <div>
              <strong id="rapidWord">â€”</strong><br>
              <span class="en" id="rapidWordHint">â€”</span>
            </div>
          </div>

          <div class="row" id="rapidChoices"></div>

          <div class="row">
            <button class="btn primary" id="rapidNew">Next</button>
            <button class="btn danger" id="rapidSaveWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          </div>

          <div class="statusLine" id="rapidFeedback"></div>
          <div class="progressRow">
            <div class="progressBox">Correct: <b id="rapidCorrect">0</b></div>
            <div class="progressBox">Wrong: <b id="rapidWrong">0</b></div>
          </div>
        </div>
      </div>

      <!-- Game: Cloze -->
      <div id="game-cloze" class="gamePane" style="display:none;">
        <div class="item">
          <h4>ğŸ§© ë¹ˆì¹¸ ì±„ìš°ê¸°</h4>
          <p class="muted">ë¬¸ì¥ ì† ë¹ˆì¹¸ì— ì•Œë§ì€ ë‹¨ì–´ë¥¼ ë„£ê¸°.<span class="en">Fill the blank with the correct word.</span></p>

          <div class="pill">
            <div>
              <strong id="clozeSentence">â€”</strong>
              <span class="en" id="clozeSentenceEN">â€”</span>
            </div>
          </div>

          <div class="row" id="clozeChoices"></div>

          <div class="row">
            <button class="btn primary" id="clozeNew">Next</button>
            <button class="btn danger" id="clozeSaveWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          </div>

          <div class="statusLine" id="clozeFeedback"></div>
        </div>
      </div>

      <!-- Game: Memory -->
      <div id="game-memory" class="gamePane" style="display:none;">
        <div class="item">
          <h4>ğŸ§  ë©”ëª¨ë¦¬(í”Œë¦½)</h4>
          <p class="muted">ê°™ì€ ìŒ(í•œêµ­ì–´-ì˜ì–´)ì„ ì°¾ê¸°. 8ìŒ ëœë¤.<span class="en">Flip cards and match Korean-English pairs.</span></p>

          <div class="row">
            <button class="btn primary" id="memoryNew">New board</button>
            <button class="btn danger" id="memorySaveWrong">ë§ì´ í‹€ë ¸ìœ¼ë©´ SRS ì €ì¥</button>
          </div>

          <div class="statusLine" id="memoryStats"></div>
          <div id="memoryBoard" style="margin-top:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- TAB: SRS -->
  <section id="tab-srs" class="tab" style="display:none;">
    <div class="card">
      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸ” í‹€ë¦° ê²ƒ ë³µìŠµ (SRS)</h3>
          <p class="muted">í‹€ë¦° í•­ëª©ë§Œ ëª¨ì•„ì„œ ë°˜ë³µ (ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨).<span class="en">Review only what you missed (saved locally).</span></p>
        </div>
        <div class="row" style="margin:0;">
          <button class="btn" id="refreshSrs">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn danger" id="clearSrs">ì „ì²´ ì‚­ì œ</button>
        </div>
      </div>

      <hr>

      <div class="list" id="srsList"></div>
      <p class="muted" id="srsEmpty" style="display:none;">ì•„ì§ ì €ì¥ëœ í•­ëª©ì´ ì—†ì–´ìš”.<span class="en">No saved items yet.</span></p>
    </div>
  </section>

  <!-- TAB: Settings -->
  <section id="tab-settings" class="tab" style="display:none;">
    <div class="card">
      <h3 class="sectionTitle">âš™ï¸ ì˜µì…˜</h3>
      <p class="muted">ë ˆìŠ¨ ë¼ë²¨/ë¬¸ë²• íƒ€ê²Ÿ/ì •ë‹µ í‘œì‹œ ë“±ì„ ë°”ê¿”ìš”.<span class="en">Edit lesson label, grammar target, and display options.</span></p>

      <hr>

      <div class="item">
        <h4>ë ˆìŠ¨ ë¼ë²¨</h4>
        <p class="muted">í™ˆ/ìƒë‹¨ ë°°ì§€ì— í‘œì‹œë˜ëŠ” ë ˆìŠ¨ ì´ë¦„<span class="en">The label shown at the top.</span></p>
        <input id="lessonLabelInput" type="text" value="Lesson: 2.4 & 2.11" />
        <div class="row">
          <button class="btn primary" id="saveLessonLabel">ì €ì¥</button>
          <button class="btn" id="resetLessonLabel">ê¸°ë³¸ê°’</button>
        </div>
      </div>

      <div class="item">
        <h4>ëª©í‘œ ë¬¸ë²•</h4>
        <p class="muted">ìƒë‹¨ ë°°ì§€ + ì²´í¬ ê·œì¹™ì— ì ìš©<span class="en">Used in checks and hints.</span></p>
        <input id="grammarInput" type="text" value="~ë‹¤ ë³´ë©´" />
        <div class="row">
          <button class="btn primary" id="saveGrammar">ì €ì¥</button>
          <button class="btn" id="resetGrammar">ê¸°ë³¸ê°’</button>
        </div>
        <p class="tiny">ì˜ˆ: ~ë”ë‹ˆ / ~(ìœ¼)ã„¹ ë•Œ / ~ê²Œ ë˜ë‹¤ / ~(ìœ¼)ë ¤ë‹¤(ê°€) ë“±<span class="en">Example: swap to other grammar patterns.</span></p>
      </div>

      <div class="item">
        <h4>ì •ë‹µ í‘œì‹œ ì˜µì…˜</h4>
        <p class="muted">ë²ˆì—­ ì •ë‹µì„ í•œ ë²ˆì— ì ‘ê±°ë‚˜ í¼ì¹˜ê¸°<span class="en">Collapse/expand all translation answers.</span></p>
        <div class="row">
          <button class="btn" id="collapseAllAnswers">ì •ë‹µ ì „ë¶€ ì ‘ê¸°</button>
          <button class="btn" id="expandAllAnswers">ì •ë‹µ ì „ë¶€ í¼ì¹˜ê¸°</button>
        </div>
      </div>

      <div class="item">
        <h4>ë°ì´í„° ì´ˆê¸°í™”</h4>
        <p class="muted">SRS/ì˜µì…˜ ì €ì¥ê°’ì„ ë¦¬ì…‹<span class="en">Reset saved SRS and settings.</span></p>
        <div class="row">
          <button class="btn danger" id="resetAll">ì „ë¶€ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
  /*********************************************************
   * CONFIG + STORAGE
   *********************************************************/
  const STORAGE = {
    SRS_KEY: "korean_srs_items_v3",
    CFG_KEY: "korean_cfg_v3",
    PICKED_KEY: "korean_picked_words_v1"
  };

  const DEFAULT_CFG = {
    lessonLabel: "Lesson: 2.4 & 2.11",
    grammarTarget: "~ë‹¤ ë³´ë©´"
  };

  function loadCfg(){
    try{
      const raw = localStorage.getItem(STORAGE.CFG_KEY);
      if(!raw) return {...DEFAULT_CFG};
      const parsed = JSON.parse(raw);
      return {...DEFAULT_CFG, ...parsed};
    }catch{
      return {...DEFAULT_CFG};
    }
  }
  function saveCfg(cfg){
    localStorage.setItem(STORAGE.CFG_KEY, JSON.stringify(cfg));
  }
  let CFG = loadCfg();

  /*********************************************************
   * DATA (EDIT THIS SECTION ANYTIME)
   *********************************************************/
  const lessonWordBank = [
    ["ì‹¤ì²œí•˜ë‹¤", "to put into practice"],
    ["ìŠµê´€", "habit"],
    ["ìœ ì§€í•˜ë‹¤", "to maintain"],
    ["ë¶„ì„í•˜ë‹¤", "to analyze"],
    ["íš¨ìœ¨", "efficiency"],
    ["ìƒíƒœ", "condition/state"],
    ["ëª©í‘œ", "goal"],
    ["ì–´ìš¸ë¦¬ë‹¤", "to suit / match"],
    ["ë¿ì´ë‹¤", "only / nothing but"]
  ];

  // Add the rest of your Knowt words here whenever you want.
  const knowtReview = [
    ["ì•„ì´ëŸ¬ë‹ˆí•˜ê²Œë„", "ironically"],
    ["ìƒì‚°ì ì´ë‹¤", "productive"],
    ["ë³´ìƒ", "reward/compensation"],
    ["ìê¸°ê³„ë°œ", "self-development"],
    ["í™•ì‹¤í•˜ë‹¤", "to be certain"],
    ["ì—´ì •", "passion"],
    ["í‰ìƒ", "lifetime"],
    ["ê´€ì ", "perspective"],
    ["ê¸°íšŒ", "opportunity"],
    ["ì•Œì•„ì°¨ë¦¬ë‹¤", "to realize / notice"],
    ["ìƒê°ì„ ì •ë¦¬í•˜ë‹¤", "to organize thoughts"],
    ["ì‹ ê²½ì„ ì“°ë‹¤", "to worry about"],
    ["ë“±ë¡í•˜ë‹¤", "to register"],
    ["ë³µì¡í•˜ë‹¤", "to be complicated"],
    ["ì†Œë¹„í•˜ë‹¤", "to consume"],
    ["ì—¬ìœ ", "leisure / slack time"]
  ];

  // Warm-up multiple choice (recognition)
  const warmupQs = [
    {
      q: "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë©´ ìƒê°ì„ ______ ìˆ˜ ìˆì–´ìš”.",
      choices: ["ì†Œë¹„í•˜ë‹¤", "ì •ë¦¬í•˜ë‹¤", "ë“±ë¡í•˜ë‹¤"],
      a: 1,
      note: "ì •ë¦¬í•˜ë‹¤ = to organize"
    },
    {
      q: "ìê¸°ê³„ë°œì„ í•˜ë©´ ìƒˆë¡œìš´ ______ê°€ ìƒê²¨ìš”.",
      choices: ["ê¸°íšŒ", "ìƒíƒœ", "íš¨ìœ¨"],
      a: 0,
      note: "ê¸°íšŒ = opportunity"
    },
    {
      q: "ì—´ì •ì„ ë”°ë¼ê°€ë©´ ëª©í‘œê°€ ë” ______ì ¸ìš”.",
      choices: ["ë³µì¡í•´", "í™•ì‹¤í•´", "ì–´ìš¸ë ¤"],
      a: 1,
      note: "í™•ì‹¤í•˜ë‹¤ â†’ í™•ì‹¤í•´ì§€ë‹¤"
    }
  ];

  // Translation items (fixed set)
  const translationItems = [
    { level:"Warm-up", en:"If you keep organizing your thoughts, stress decreases.",
      ko:"ìƒê°ì„ ì •ë¦¬í•˜ë‹¤ ë³´ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¤„ì–´ë“¤ì–´ìš”." },
    { level:"Warm-up", en:"If you keep working productively, you get rewarded.",
      ko:"ìƒì‚°ì ìœ¼ë¡œ ì¼í•˜ë‹¤ ë³´ë©´ ë³´ìƒì„ ë°›ê²Œ ë¼ìš”." },
    { level:"Warm-up", en:"If you keep doing self-development, new opportunities appear.",
      ko:"ìê¸°ê³„ë°œì„ ê³„ì†í•˜ë‹¤ ë³´ë©´ ìƒˆë¡œìš´ ê¸°íšŒê°€ ìƒê²¨ìš”." },
    { level:"Warm-up", en:"If you keep analyzing situations, your perspective changes.",
      ko:"ìƒí™©ì„ ê³„ì† ë¶„ì„í•˜ë‹¤ ë³´ë©´ ê´€ì ì´ ë‹¬ë¼ì ¸ìš”." },

    { level:"Core", en:"If you keep following your passion, your life changes.",
      ko:"ì—´ì •ì„ ë”°ë¼ê°€ë‹¤ ë³´ë©´ ì‚¶ì´ ë‹¬ë¼ì ¸ìš”." },
    { level:"Core", en:"If you keep worrying about small things, life becomes complicated.",
      ko:"ì‘ì€ ì¼ì— ê³„ì† ì‹ ê²½ì„ ì“°ë‹¤ ë³´ë©´ ì‚¶ì´ ë³µì¡í•´ì ¸ìš”." },
    { level:"Core", en:"If you keep studying every day, studying becomes a habit.",
      ko:"ë§¤ì¼ ê³µë¶€í•˜ë‹¤ ë³´ë©´ ê³µë¶€ê°€ ìŠµê´€ì´ ë¼ìš”." },
    { level:"Core", en:"If you keep trying, you eventually find a method that suits you.",
      ko:"ê³„ì† ì‹œë„í•˜ë‹¤ ë³´ë©´ ë‚˜ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ë°©ë²•ì„ ì°¾ê²Œ ë¼ìš”." },

    { level:"Challenge", en:"If you keep working toward your goal, success becomes certain.",
      ko:"ëª©í‘œë¥¼ í–¥í•´ ê³„ì† ë…¸ë ¥í•˜ë‹¤ ë³´ë©´ ì„±ê³µì€ í™•ì‹¤í•´ì ¸ìš”." },
    { level:"Challenge", en:"If you keep practicing good habits, efficiency improves.",
      ko:"ì¢‹ì€ ìŠµê´€ì„ ê³„ì† ì‹¤ì²œí•˜ë‹¤ ë³´ë©´ íš¨ìœ¨ì´ ì¢‹ì•„ì ¸ìš”." },
    { level:"Challenge", en:"If you keep managing stress, your mindset changes.",
      ko:"ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë‹¤ ë³´ë©´ ìƒê°ì´ ë‹¬ë¼ì ¸ìš”." },
    { level:"Challenge", en:"If you keep reducing phone use, you gain more free time.",
      ko:"í•¸ë“œí° ì‚¬ìš©ì„ ì¤„ì´ë‹¤ ë³´ë©´ ì—¬ìœ  ì‹œê°„ì´ ìƒê²¨ìš”." }
  ];

  // Sentence idea prompts
  const ideaPrompts = [
    "ìê¸°ê³„ë°œ + ìŠµê´€ + ëª©í‘œë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ìƒê° ì •ë¦¬ + ìŠ¤íŠ¸ë ˆìŠ¤ + ìƒíƒœë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ì—´ì • + ê¸°íšŒ + ê´€ì ìœ¼ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ì‹ ê²½ ì“°ë‹¤ + ë³µì¡í•˜ë‹¤ + íš¨ìœ¨ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ë¶„ì„í•˜ë‹¤ + ëª©í‘œ + í™•ì‹¤í•˜ë‹¤ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°"
  ];

  /*********************************************************
   * HELPERS
   *********************************************************/
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function uniq(arr){
    const seen = new Set();
    return arr.filter(x => (seen.has(x) ? false : (seen.add(x), true)));
  }

  /*********************************************************
   * TABS
   *********************************************************/
  const tabButtons = document.querySelectorAll(".tabBtn");
  const tabMap = {
    warmup: document.getElementById("tab-warmup"),
    translate: document.getElementById("tab-translate"),
    builder: document.getElementById("tab-builder"),
    reading: document.getElementById("tab-reading"),
    games: document.getElementById("tab-games"),
    srs: document.getElementById("tab-srs"),
    settings: document.getElementById("tab-settings")
  };

  function showTab(key){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
    Object.entries(tabMap).forEach(([k,el]) => el.style.display = (k===key ? "block" : "none"));
    if(key === "srs") renderSrs();
  }
  tabButtons.forEach(btn => btn.addEventListener("click", () => showTab(btn.dataset.tab)));

  // Keyboard shortcuts 1-7
  window.addEventListener("keydown", (e)=>{
    if (["INPUT","TEXTAREA"].includes(document.activeElement?.tagName)) return;
    if(e.key === "1") showTab("warmup");
    if(e.key === "2") showTab("translate");
    if(e.key === "3") showTab("builder");
    if(e.key === "4") showTab("reading");
    if(e.key === "5") showTab("games");
    if(e.key === "6") showTab("srs");
    if(e.key === "7") showTab("settings");
  });

  /*********************************************************
   * HEADER + CFG APPLY
   *********************************************************/
  const badgeLesson = document.getElementById("badgeLesson");
  const badgeGrammar = document.getElementById("badgeGrammar");
  const grammarInline = document.getElementById("grammarInline");
  const grammarInline2 = document.getElementById("grammarInline2");

  function applyCfg(){
    badgeLesson.textContent = CFG.lessonLabel;
    badgeGrammar.textContent = `Target: ${CFG.grammarTarget}`;
    grammarInline.textContent = CFG.grammarTarget;
    grammarInline2.textContent = CFG.grammarTarget;
  }

  /*********************************************************
   * VOCAB PREVIEW + PICK 3
   *********************************************************/
  const vocabPreviewEl = document.getElementById("vocabPreview");
  const shuffleVocabBtn = document.getElementById("shuffleVocab");
  const copyVocabBtn = document.getElementById("copyVocab");
  const pick3WordsBtn = document.getElementById("pick3Words");
  const pickedWordsLine = document.getElementById("pickedWordsLine");

  let vocabMixed = [];
  function rebuildVocabMixed(){
    vocabMixed = [...lessonWordBank, ...knowtReview];
  }
  function renderVocabPreview(list){
    const out = list.map(([k,e]) => `â€¢ <b>${escapeHtml(k)}</b> â€” ${escapeHtml(e)}`).join("<br>");
    vocabPreviewEl.innerHTML = out;
  }
  function savePickedWords(words){
    localStorage.setItem(STORAGE.PICKED_KEY, JSON.stringify(words));
  }
  function loadPickedWords(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE.PICKED_KEY) || "[]");
    }catch{
      return [];
    }
  }
  function showPickedWords(){
    const w = loadPickedWords();
    if(!w.length){
      pickedWordsLine.innerHTML = `<span class="tiny">ì˜¤ëŠ˜ 3ë‹¨ì–´ë¥¼ ë½‘ì•„ë³´ì„¸ìš”. / Pick 3 words for today's challenge.</span>`;
      return;
    }
    pickedWordsLine.innerHTML = `<span class="ok">ì˜¤ëŠ˜ì˜ 3ë‹¨ì–´:</span> ${w.map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join(" ")}`;
  }

  shuffleVocabBtn.addEventListener("click", ()=> renderVocabPreview(shuffle(vocabMixed)));

  copyVocabBtn.addEventListener("click", async ()=>{
    const txt = vocabMixed.map(([k,e]) => `${k}\t${e}`).join("\n");
    try{
      await navigator.clipboard.writeText(txt);
      copyVocabBtn.textContent = "ë³µì‚¬ë¨";
      setTimeout(()=>copyVocabBtn.textContent="ë‹¨ì–´ ë³µì‚¬", 900);
    }catch{
      copyVocabBtn.textContent = "ë³µì‚¬ ì‹¤íŒ¨";
      setTimeout(()=>copyVocabBtn.textContent="ë‹¨ì–´ ë³µì‚¬", 900);
    }
  });

  pick3WordsBtn.addEventListener("click", ()=>{
    const candidates = vocabMixed.map(([k])=>k);
    const pickSet = shuffle(candidates).slice(0,3);
    savePickedWords(pickSet);
    showPickedWords();
  });

  /*********************************************************
   * SRS (localStorage)
   *********************************************************/
  function loadSrs(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE.SRS_KEY) || "[]");
    } catch {
      return [];
    }
  }
  function saveSrs(items){
    localStorage.setItem(STORAGE.SRS_KEY, JSON.stringify(items));
  }
  function addToSrs(item){
    const items = loadSrs();
    items.unshift({
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random()),
      ts: Date.now(),
      ...item
    });
    saveSrs(items);
  }
  function removeFromSrs(id){
    const items = loadSrs().filter(x=>x.id!==id);
    saveSrs(items);
  }

  /*********************************************************
   * WARM-UP RENDER
   *********************************************************/
  const warmupList = document.getElementById("warmupList");

  function renderWarmup(){
    warmupList.innerHTML = "";
    warmupQs.forEach((qObj, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h4>Q${idx+1}. ${escapeHtml(qObj.q)}</h4>
        <div class="row">
          ${qObj.choices.map((c,i)=>`<button class="btn small" data-i="${i}">${escapeHtml(c)}</button>`).join("")}
        </div>
        <p class="muted" style="margin-top:8px;">
          <span class="badge" id="warmupBadge${idx}">ì„ íƒí•˜ì„¸ìš” / Choose</span>
          <span style="margin-left:8px;">${escapeHtml(qObj.note || "")}</span>
        </p>
      `;
      const badge = el.querySelector(`#warmupBadge${idx}`);
      el.querySelectorAll("button[data-i]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const pickIdx = Number(b.dataset.i);
          if (pickIdx === qObj.a){
            badge.textContent = "ì •ë‹µ / Correct";
            badge.className = "badge ok";
          } else {
            badge.textContent = "í‹€ë¦¼ â†’ SRS ì €ì¥ / Wrong â†’ Saved";
            badge.className = "badge bad";
            addToSrs({
              type:"warmup",
              prompt:qObj.q,
              user:qObj.choices[pickIdx],
              answer:qObj.choices[qObj.a],
              meta:`Q${idx+1} / ì›Œë°ì—…`
            });
          }
        });
      });
      warmupList.appendChild(el);
    });
  }

  /*********************************************************
   * TRANSLATION RENDER (fixed list)
   *********************************************************/
  const translationList = document.getElementById("translationList");
  const translationCount = document.getElementById("translationCount");
  const filterLevel = document.getElementById("filterLevel");

  function renderTranslations(){
    translationList.innerHTML = "";

    const lvl = filterLevel.value;
    const base = translationItems.map(x => ({...x}));
    const gen = generatedHistory.map(x => ({...x, level:"Generated"}));
    const itemsAll = [...base, ...gen];

    const items = (lvl === "ALL") ? itemsAll : itemsAll.filter(x => x.level === lvl);

    items.forEach((it, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h4>${idx+1}. <span class="badge">${escapeHtml(it.level)}</span> ${escapeHtml(it.en)}</h4>
        <details class="ansDetails">
          <summary>ì •ë‹µ ë³´ê¸° / Show answer</summary>
          <div class="answer">${escapeHtml(it.ko)}</div>
        </details>
        <div class="row">
          <button class="btn small danger" data-action="wrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          <button class="btn small" data-action="copy">ì •ë‹µ ë³µì‚¬</button>
        </div>
        <p class="muted">íŒíŠ¸: ${escapeHtml(CFG.grammarTarget)} í¬í•¨<span class="en">Hint: include the target grammar.</span></p>
      `;
      el.querySelector('button[data-action="wrong"]').addEventListener("click", ()=>{
        addToSrs({
          type:"translation",
          prompt: it.en,
          answer: it.ko,
          meta: `${it.level} / ë²ˆì—­ ì—°ìŠµ`
        });
        el.querySelector('button[data-action="wrong"]').textContent = "ì €ì¥ë¨";
      });
      el.querySelector('button[data-action="copy"]').addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(it.ko);
          el.querySelector('button[data-action="copy"]').textContent = "ë³µì‚¬ë¨";
          setTimeout(()=>el.querySelector('button[data-action="copy"]').textContent="ì •ë‹µ ë³µì‚¬", 900);
        }catch{
          el.querySelector('button[data-action="copy"]').textContent = "ì‹¤íŒ¨";
          setTimeout(()=>el.querySelector('button[data-action="copy"]').textContent="ì •ë‹µ ë³µì‚¬", 900);
        }
      });
      translationList.appendChild(el);
    });

    translationCount.textContent = `í‘œì‹œ ì¤‘: ${items.length}ê°œ / Showing: ${items.length}`;
  }
  filterLevel.addEventListener("change", renderTranslations);

  /*********************************************************
   * TRANSLATION GENERATOR (new sentences with word bank)
   *********************************************************/
  const genTranslationBtn = document.getElementById("genTranslation");
  const genHintBtn = document.getElementById("genHint");
  const revealModelBtn = document.getElementById("revealModel");
  const saveGenWrongBtn = document.getElementById("saveGenWrong");
  const genMeta = document.getElementById("genMeta");
  const genEN = document.getElementById("genEN");
  const genHints = document.getElementById("genHints");
  const genUserKO = document.getElementById("genUserKO");
  const genModelKO = document.getElementById("genModelKO");
  const modelWrap = document.getElementById("modelWrap");
  const genFeedback = document.getElementById("genFeedback");

  let generatedCurrent = null;
  let generatedHistory = [];

  // A few safe, reusable meaning templates
  const genTemplates = [
    {
      // if you keep doing X, you naturally become/it becomes Y
      build: (xVerbKo, xVerbEn, yKo, yEn) => ({
        en: `If you keep ${xVerbEn}, ${yEn}.`,
        ko: `${xVerbKo} ${CFG.grammarTarget} ${yKo}.`
      })
    }
  ];

  // Make sure Korean verb phrase ends nicely before CFG.grammarTarget
  function joinKo(phrase){
    // If phrase already ends with "ë‹¤" (dictionary) or "í•˜ë‹¤", we can attach.
    return phrase.trim();
  }

  // Pools (use vocab + some extra safe verbs)
  const verbPool = [
    { ko:"ìƒê°ì„ ì •ë¦¬í•˜ë‹¤", en:"organizing your thoughts" },
    { ko:"ìê¸°ê³„ë°œì„ í•˜ë‹¤", en:"doing self-development" },
    { ko:"ìŠµê´€ì„ ìœ ì§€í•˜ë‹¤", en:"maintaining a habit" },
    { ko:"ìƒí™©ì„ ë¶„ì„í•˜ë‹¤", en:"analyzing situations" },
    { ko:"ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë‹¤", en:"managing stress" },
    { ko:"í•¸ë“œí° ì‚¬ìš©ì„ ì¤„ì´ë‹¤", en:"reducing phone use" },
    { ko:"ëª©í‘œë¥¼ í–¥í•´ ë…¸ë ¥í•˜ë‹¤", en:"working toward your goal" },
    { ko:"ìƒì‚°ì ìœ¼ë¡œ ì¼í•˜ë‹¤", en:"working productively" }
  ];

  const outcomePool = [
    { ko:"ì—¬ìœ  ì‹œê°„ì´ ìƒê²¨ìš”", en:"you gain more free time" },
    { ko:"ê´€ì ì´ ë‹¬ë¼ì ¸ìš”", en:"your perspective changes" },
    { ko:"íš¨ìœ¨ì´ ì¢‹ì•„ì ¸ìš”", en:"your efficiency improves" },
    { ko:"ìŠµê´€ì´ ë¼ìš”", en:"it becomes a habit" },
    { ko:"ì„±ê³µì´ ë” í™•ì‹¤í•´ì ¸ìš”", en:"success becomes more certain" },
    { ko:"ê¸°íšŒê°€ ìƒê²¨ìš”", en:"opportunities appear" },
    { ko:"ë§ˆìŒì´ í¸í•´ì ¸ìš”", en:"you feel more at ease" }
  ];

  function pickHintsFromWordBank(n=3){
    const words = shuffle(vocabMixed.map(([k])=>k)).slice(0,n);
    return words;
  }

  function generateTranslation(){
    const x = pick(verbPool);
    const y = pick(outcomePool);
    const tpl = pick(genTemplates);

    const built = tpl.build(joinKo(x.ko), x.en, y.ko, y.en);

    const hints = pickHintsFromWordBank(3);
    // ensure hints include something relevant sometimes
    const forced = shuffle([pick(lessonWordBank)[0], pick(knowtReview)[0]]).slice(0,1);
    const hintFinal = uniq([...forced, ...hints]).slice(0,4);

    generatedCurrent = {
      level:"Generated",
      en: built.en,
      ko: built.ko,
      hints: hintFinal
    };

    genMeta.textContent = `Generated â€¢ Target: ${CFG.grammarTarget}`;
    genEN.textContent = generatedCurrent.en;
    genHints.innerHTML = hintFinal.map(w=>`<span class="badge">${escapeHtml(w)}</span>`).join(" ");
    genUserKO.value = "";
    genModelKO.textContent = built.ko;
    genFeedback.textContent = "";
    modelWrap.removeAttribute("open");
  }

  function checkGeneratedAttempt(){
    if(!generatedCurrent) return;
    const s = genUserKO.value.trim();
    if(!s){
      genFeedback.innerHTML = `<span class="warn">ë¨¼ì € ë²ˆì—­ì„ ì…ë ¥í•´ìš”. / Type your translation first.</span>`;
      return;
    }
    const hasG = hasGrammar(s);
    const hits = countVocabHits(s);
    const hintHits = generatedCurrent.hints.filter(w => s.includes(w)).length;

    const parts = [];
    parts.push(hasG ? `<span class="ok">ë¬¸ë²• OK</span>` : `<span class="bad">ë¬¸ë²• ì—†ìŒ</span>`);
    parts.push(hits >= 2 ? `<span class="ok">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ</span>` : `<span class="warn">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ</span>`);
    parts.push(hintHits >= 1 ? `<span class="ok">íŒíŠ¸ ë‹¨ì–´ ì‚¬ìš© ${hintHits}ê°œ</span>` : `<span class="warn">íŒíŠ¸ ë‹¨ì–´ 0ê°œ</span>`);
    genFeedback.innerHTML = parts.join(" / ");
  }

  genTranslationBtn.addEventListener("click", ()=>{
    generateTranslation();
    // also add it to history list so it can appear below if user wants
    if(generatedCurrent){
      generatedHistory.unshift({ level:"Generated", en: generatedCurrent.en, ko: generatedCurrent.ko });
      generatedHistory = generatedHistory.slice(0,30);
      renderTranslations();
    }
  });

  genHintBtn.addEventListener("click", ()=>{
    if(!generatedCurrent) generateTranslation();
    genFeedback.innerHTML = `<span class="ok">íŒíŠ¸:</span> ${generatedCurrent.hints.map(w=>`<span class="badge">${escapeHtml(w)}</span>`).join(" ")} 
      <span class="en">Try using at least one of these words.</span>`;
  });

  revealModelBtn.addEventListener("click", ()=>{
    if(!generatedCurrent) generateTranslation();
    modelWrap.setAttribute("open","");
    checkGeneratedAttempt();
  });

  genUserKO.addEventListener("input", ()=>{
    // light live check
    if(genUserKO.value.trim().length > 8) checkGeneratedAttempt();
  });

  saveGenWrongBtn.addEventListener("click", ()=>{
    if(!generatedCurrent){
      genFeedback.innerHTML = `<span class="warn">ë¨¼ì € ë¬¸ì¥ì„ ìƒì„±í•´ìš”. / Generate a sentence first.</span>`;
      return;
    }
    addToSrs({
      type:"gen-translation",
      prompt: generatedCurrent.en,
      user: genUserKO.value.trim() || "(no attempt)",
      answer: generatedCurrent.ko,
      meta:"Generated / ë²ˆì—­"
    });
    genFeedback.innerHTML = `<span class="ok">SRS ì €ì¥ ì™„ë£Œ. / Saved to SRS.</span>`;
  });

  /*********************************************************
   * SENTENCE BUILDER
   *********************************************************/
  const insertTemplateBtn = document.getElementById("insertTemplate");
  const insertIdeaBtn = document.getElementById("insertIdea");
  const usePickedWordsBtn = document.getElementById("usePickedWords");
  const userSentence = document.getElementById("userSentence");
  const checkSentenceBtn = document.getElementById("checkSentence");
  const markSentenceWrongBtn = document.getElementById("markSentenceWrong");
  const clearSentenceBtn = document.getElementById("clearSentence");
  const sentenceFeedback = document.getElementById("sentenceFeedback");
  const ideaLine = document.getElementById("ideaLine");

  function countVocabHits(sentence){
    const uniqHits = new Set();
    vocabMixed.forEach(([k])=>{ if(sentence.includes(k)) uniqHits.add(k); });
    return uniqHits.size;
  }

  function hasGrammar(sentence){
    const g = CFG.grammarTarget.trim();
    if(!g) return false;
    // Special: for ~ë‹¤ ë³´ë©´ we accept spacing variations
    if(g.includes("ë‹¤ ë³´ë©´")){
      if(sentence.includes("ë‹¤ ë³´ë©´") || sentence.includes("ë‹¤ë³´ë©´")) return true;
    }
    return sentence.includes(g);
  }

  insertTemplateBtn.addEventListener("click", ()=>{
    userSentence.value = `___í•˜ë‹¤ ë³´ë©´ ___(ì´/ê°€) ë‹¬ë¼ì ¸ìš”. (${CFG.grammarTarget})`;
    userSentence.focus();
  });

  insertIdeaBtn.addEventListener("click", ()=>{
    ideaLine.textContent = `ì•„ì´ë””ì–´: ${pick(ideaPrompts)}`;
  });

  usePickedWordsBtn.addEventListener("click", ()=>{
    const w = loadPickedWords();
    if(!w.length){
      ideaLine.innerHTML = `<span class="warn">ë¨¼ì € ì›Œë°ì—… íƒ­ì—ì„œ 3ë‹¨ì–´ë¥¼ ë½‘ì•„ì¤˜! / Pick 3 words first.</span>`;
      return;
    }
    ideaLine.innerHTML = `<span class="ok">ì´ ë‹¨ì–´ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°:</span> ${w.map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join(" ")}`;
  });

  clearSentenceBtn.addEventListener("click", ()=>{
    userSentence.value = "";
    sentenceFeedback.textContent = "";
  });

  checkSentenceBtn.addEventListener("click", ()=>{
    const s = userSentence.value.trim();
    if(!s){
      sentenceFeedback.innerHTML = `<span class="warn">ë¬¸ì¥ì„ ë¨¼ì € ì¨ì¤˜! / Write a sentence first.</span>`;
      return;
    }
    const gOk = hasGrammar(s);
    const hits = countVocabHits(s);

    const parts = [];
    parts.push(gOk ? `<span class="ok">ë¬¸ë²• OK</span>` : `<span class="bad">ë¬¸ë²• ì—†ìŒ (${escapeHtml(CFG.grammarTarget)})</span>`);
    parts.push(hits >= 3 ? `<span class="ok">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ</span>` : `<span class="warn">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ (3ê°œ ì´ìƒ)</span>`);
    sentenceFeedback.innerHTML = parts.join(" / ");
  });

  markSentenceWrongBtn.addEventListener("click", ()=>{
    const s = userSentence.value.trim();
    if(!s){
      sentenceFeedback.innerHTML = `<span class="warn">ì €ì¥í•  ë¬¸ì¥ì´ ì—†ì–´. / Nothing to save.</span>`;
      return;
    }
    addToSrs({
      type:"sentence",
      prompt:"ë‚´ ë¬¸ì¥ (ë¬¸ì¥ ë§Œë“¤ê¸°)",
      user:s,
      answer:"(ì •ë‹µ ì—†ìŒ: ë‚˜ì¤‘ì— ê³ ì³ì„œ ì—…ê·¸ë ˆì´ë“œ)",
      meta:"ë¬¸ì¥ ë§Œë“¤ê¸°"
    });
    sentenceFeedback.innerHTML = `<span class="ok">SRSì— ì €ì¥í–ˆì–´. / Saved to SRS.</span>`;
  });

  /*********************************************************
   * READING + QUESTIONS
   *********************************************************/
  const newStoryBtn = document.getElementById("newStory");
  const toggleGlossBtn = document.getElementById("toggleGloss");
  const saveReadingWrongBtn = document.getElementById("saveReadingWrong");
  const storyTitle = document.getElementById("storyTitle");
  const storyKorean = document.getElementById("storyKorean");
  const storyEnglish = document.getElementById("storyEnglish");
  const storyGloss = document.getElementById("storyGloss");
  const glossWrap = document.getElementById("glossWrap");
  const readingQs = document.getElementById("readingQs");
  const checkReadingBtn = document.getElementById("checkReading");
  const readingFeedback = document.getElementById("readingFeedback");

  const storyBank = [
    {
      title:"ì—¬ìœ  ì‹œê°„ì„ ë§Œë“œëŠ” ìŠµê´€",
      ko:[
        "ìš”ì¦˜ ë¯¸ë¼ëŠ” í•¸ë“œí°ì„ ë„ˆë¬´ ë§ì´ ì“°ëŠ” ê²ƒ ê°™ë‹¤ê³  ëŠê¼ˆì–´ìš”.",
        "ê·¸ë˜ì„œ í•˜ë£¨ì— 10ë¶„ì”©ë§Œ ì‚¬ìš© ì‹œê°„ì„ ì¤„ì´ê¸°ë¡œ í–ˆì–´ìš”.",
        "ì²˜ìŒì—ëŠ” ì–´ë µë”ë‹ˆ, ì¤„ì´ë‹¤ ë³´ë©´ ì ì  ìµìˆ™í•´ì¡Œì–´ìš”.",
        "ì¼ì£¼ì¼ì´ ì§€ë‚˜ì ì—¬ìœ  ì‹œê°„ì´ ìƒê²¼ê³ , ê·¸ ì‹œê°„ì— ìê¸°ê³„ë°œì„ ì‹œì‘í–ˆì–´ìš”.",
        "ìŠµê´€ì„ ìœ ì§€í•˜ë‹¤ ë³´ë©´ íš¨ìœ¨ì´ ì¢‹ì•„ì§„ë‹¤ëŠ” ê±¸ ì•Œì•„ì°¨ë ¸ì–´ìš”."
      ].join(" "),
      en:[
        "Lately, Mira felt she was using her phone too much.",
        "So she decided to reduce her phone time by just 10 minutes a day.",
        "At first it was hard, but as she kept reducing it, it became familiar.",
        "After a week, she gained free time and started self-development during that time.",
        "She realized that maintaining habits can improve efficiency."
      ].join(" "),
      gloss:[
        ["ì—¬ìœ  ì‹œê°„","free time"],
        ["ìŠµê´€","habit"],
        ["ìœ ì§€í•˜ë‹¤","maintain"],
        ["ìê¸°ê³„ë°œ","self-development"],
        ["ì•Œì•„ì°¨ë¦¬ë‹¤","notice/realize"]
      ],
      qs:[
        { q:"ë¯¸ë¼ëŠ” ë¬´ì—‡ì„ ì¤„ì´ê¸°ë¡œ í–ˆì–´ìš”?", a:"í•¸ë“œí° ì‚¬ìš© ì‹œê°„ì„ ì¤„ì´ê¸°ë¡œ í–ˆì–´ìš”." },
        { q:"í•¸ë“œí° ì‚¬ìš©ì„ ì¤„ì´ë‹¤ ë³´ë‹ˆ ì–´ë–¤ ê²°ê³¼ê°€ ìƒê²¼ì–´ìš”?", a:"ì—¬ìœ  ì‹œê°„ì´ ìƒê²¼ì–´ìš”." },
        { q:"ì—¬ìœ  ì‹œê°„ì´ ìƒê¸°ì ë¯¸ë¼ëŠ” ë¬´ì—‡ì„ ì‹œì‘í–ˆì–´ìš”?", a:"ìê¸°ê³„ë°œì„ ì‹œì‘í–ˆì–´ìš”." }
      ]
    },
    {
      title:"ëª©í‘œê°€ í™•ì‹¤í•´ì§€ëŠ” ìˆœê°„",
      ko:[
        "ë¯¼ì§€ëŠ” ëª©í‘œê°€ ë§ì•„ì„œ ëŠ˜ ë³µì¡í•œ ëŠë‚Œì´ì—ˆì–´ìš”.",
        "í•˜ì§€ë§Œ ë§¤ì¼ 5ë¶„ì”© ìƒê°ì„ ì •ë¦¬í•˜ê¸° ì‹œì‘í–ˆì–´ìš”.",
        "ìƒê°ì„ ì •ë¦¬í•˜ë‹¤ ë³´ë©´ ìš°ì„ ìˆœìœ„ê°€ ë³´ì´ê¸° ì‹œì‘í–ˆê³ , ëª©í‘œê°€ ë” í™•ì‹¤í•´ì¡Œì–´ìš”.",
        "ë¶ˆí•„ìš”í•œ ê±±ì •ì— ì‹ ê²½ì„ ì“°ì§€ ì•Šìœ¼ë ¤ê³  ì‹¤ì²œí–ˆì–´ìš”.",
        "ê·¸ ê²°ê³¼, í•˜ë£¨ê°€ ë” ìƒì‚°ì ìœ¼ë¡œ ë³€í–ˆì–´ìš”."
      ].join(" "),
      en:[
        "Minji had many goals and always felt overwhelmed.",
        "But she started organizing her thoughts for five minutes each day.",
        "As she kept organizing, priorities became clearer and her goals became more certain.",
        "She practiced not focusing on unnecessary worries.",
        "As a result, her days became more productive."
      ].join(" "),
      gloss:[
        ["ìƒê°ì„ ì •ë¦¬í•˜ë‹¤","organize thoughts"],
        ["ìš°ì„ ìˆœìœ„","priority"],
        ["í™•ì‹¤í•˜ë‹¤","certain"],
        ["ì‹¤ì²œí•˜ë‹¤","put into practice"],
        ["ìƒì‚°ì ì´ë‹¤","productive"]
      ],
      qs:[
        { q:"ë¯¼ì§€ëŠ” ë§¤ì¼ ë¬´ì—‡ì„ í–ˆì–´ìš”?", a:"ìƒê°ì„ 5ë¶„ì”© ì •ë¦¬í–ˆì–´ìš”." },
        { q:"ìƒê°ì„ ì •ë¦¬í•˜ë‹¤ ë³´ë‹ˆ ë¬´ì—‡ì´ ë³´ì´ê¸° ì‹œì‘í–ˆì–´ìš”?", a:"ìš°ì„ ìˆœìœ„ê°€ ë³´ì´ê¸° ì‹œì‘í–ˆì–´ìš”." },
        { q:"ê²°ê³¼ì ìœ¼ë¡œ ë¯¼ì§€ì˜ í•˜ë£¨ëŠ” ì–´ë–»ê²Œ ë³€í–ˆì–´ìš”?", a:"ë” ìƒì‚°ì ìœ¼ë¡œ ë³€í–ˆì–´ìš”." }
      ]
    }
  ];

  let currentStory = null;

  function renderStory(){
    currentStory = pick(storyBank);
    storyTitle.textContent = currentStory.title;
    storyKorean.textContent = currentStory.ko;
    storyEnglish.textContent = currentStory.en;

    storyGloss.innerHTML = currentStory.gloss.map(([k,e]) => `â€¢ <b>${escapeHtml(k)}</b> â€” ${escapeHtml(e)}`).join("<br>");

    readingQs.innerHTML = "";
    currentStory.qs.forEach((qq, idx)=>{
      const box = document.createElement("div");
      box.className = "item";
      box.innerHTML = `
        <h4>Q${idx+1}. ${escapeHtml(qq.q)}</h4>
        <textarea data-idx="${idx}" placeholder="í•œêµ­ì–´ë¡œ ë‹µí•´ë³´ì„¸ìš”. / Answer in Korean."></textarea>
        <details style="margin-top:10px">
          <summary>ëª¨ë²” ë‹µì•ˆ / Model answer</summary>
          <div class="answer">${escapeHtml(qq.a)}</div>
        </details>
      `;
      readingQs.appendChild(box);
    });

    readingFeedback.textContent = "";
  }

  newStoryBtn.addEventListener("click", renderStory);

  toggleGlossBtn.addEventListener("click", ()=>{
    if(glossWrap.hasAttribute("open")) glossWrap.removeAttribute("open");
    else glossWrap.setAttribute("open","");
  });

  checkReadingBtn.addEventListener("click", ()=>{
    if(!currentStory) return;
    // simple check: did they answer each question at all + grammar presence in at least one answer
    const answers = Array.from(readingQs.querySelectorAll("textarea")).map(t => t.value.trim());
    const filled = answers.filter(a => a.length > 0).length;
    const anyGrammar = answers.some(a => hasGrammar(a));
    const msg = [];
    msg.push(filled === currentStory.qs.length ? `<span class="ok">ë‹µë³€ ${filled}/${currentStory.qs.length} ì™„ë£Œ</span>` : `<span class="warn">ë‹µë³€ ${filled}/${currentStory.qs.length} (ë” ì¨ë³´ì)</span>`);
    msg.push(anyGrammar ? `<span class="ok">ë¬¸ë²• ì‚¬ìš© ê°ì§€</span>` : `<span class="warn">ë¬¸ë²•(${escapeHtml(CFG.grammarTarget)})ë¥¼ í•œ ë²ˆ ë„£ì–´ë´</span>`);
    readingFeedback.innerHTML = msg.join(" / ");
  });

  saveReadingWrongBtn.addEventListener("click", ()=>{
    if(!currentStory){
      readingFeedback.innerHTML = `<span class="warn">ë¨¼ì € ì´ì•¼ê¸°ë¥¼ ë¶ˆëŸ¬ì™€ìš”. / Load a story first.</span>`;
      return;
    }
    const answers = Array.from(readingQs.querySelectorAll("textarea")).map((t,i)=>`Q${i+1}: ${t.value.trim() || "(blank)"}`).join("\n");
    addToSrs({
      type:"reading",
      prompt:`[Story] ${currentStory.title}`,
      user: answers,
      answer:"ëª¨ë²” ë‹µì•ˆì€ ê° ì§ˆë¬¸ ì•„ë˜ì—ì„œ í™•ì¸ ê°€ëŠ¥",
      meta:"ì½ê¸°/ì§ˆë¬¸"
    });
    readingFeedback.innerHTML = `<span class="ok">SRS ì €ì¥ ì™„ë£Œ. / Saved to SRS.</span>`;
  });

  /*********************************************************
   * GAMES
   *********************************************************/
  const gameChips = document.querySelectorAll(".chip");
  const rapidPane = document.getElementById("game-rapid");
  const clozePane = document.getElementById("game-cloze");
  const memoryPane = document.getElementById("game-memory");

  function showGame(key){
    rapidPane.style.display = (key==="rapid") ? "block" : "none";
    clozePane.style.display = (key==="cloze") ? "block" : "none";
    memoryPane.style.display = (key==="memory") ? "block" : "none";
    gameChips.forEach(c => c.classList.toggle("active", c.dataset.game === key));
  }
  gameChips.forEach(c => c.addEventListener("click", ()=> showGame(c.dataset.game)));

  // Rapid
  const rapidWordEl = document.getElementById("rapidWord");
  const rapidWordHintEl = document.getElementById("rapidWordHint");
  const rapidChoices = document.getElementById("rapidChoices");
  const rapidNewBtn = document.getElementById("rapidNew");
  const rapidSaveWrongBtn = document.getElementById("rapidSaveWrong");
  const rapidFeedback = document.getElementById("rapidFeedback");
  const rapidCorrectEl = document.getElementById("rapidCorrect");
  const rapidWrongEl = document.getElementById("rapidWrong");

  let rapidState = { current:null, correct:0, wrong:0 };

  function newRapid(){
    const pool = vocabMixed;
    const correct = pick(pool);
    const wrongs = shuffle(pool.filter(x => x[0] !== correct[0])).slice(0,3);
    const choices = shuffle([correct, ...wrongs]);

    rapidState.current = { correct, choices };
    rapidWordEl.textContent = correct[0];
    rapidWordHintEl.textContent = "(choose the meaning)";
    rapidFeedback.textContent = "";
    rapidChoices.innerHTML = "";

    choices.forEach(([k,e])=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = e;
      b.addEventListener("click", ()=>{
        if(k === correct[0]){
          rapidState.correct++;
          rapidFeedback.innerHTML = `<span class="ok">ì •ë‹µ!</span> ${escapeHtml(k)} = ${escapeHtml(e)}`;
        } else {
          rapidState.wrong++;
          rapidFeedback.innerHTML = `<span class="bad">í‹€ë¦¼</span> ì •ë‹µ: ${escapeHtml(correct[0])} = ${escapeHtml(correct[1])}`;
          addToSrs({
            type:"game-rapid",
            prompt:`ëœ» ë§íˆê¸°: ${correct[0]}`,
            user:`picked: ${e}`,
            answer:`${correct[1]}`,
            meta:"ê²Œì„/ëœ» ë§íˆê¸°"
          });
        }
        rapidCorrectEl.textContent = String(rapidState.correct);
        rapidWrongEl.textContent = String(rapidState.wrong);
      });
      rapidChoices.appendChild(b);
    });
  }

  rapidNewBtn.addEventListener("click", newRapid);
  rapidSaveWrongBtn.addEventListener("click", ()=>{
    if(!rapidState.current){
      rapidFeedback.innerHTML = `<span class="warn">ë¨¼ì € Next ëˆŒëŸ¬ ì‹œì‘! / Press Next to start.</span>`;
      return;
    }
    const c = rapidState.current.correct;
    addToSrs({
      type:"game-rapid",
      prompt:`ëœ» ë§íˆê¸°(ì €ì¥): ${c[0]}`,
      user:"(manual save)",
      answer:c[1],
      meta:"ê²Œì„/ëœ» ë§íˆê¸°"
    });
    rapidFeedback.innerHTML = `<span class="ok">ì €ì¥ ì™„ë£Œ. / Saved.</span>`;
  });

  // Cloze
  const clozeSentence = document.getElementById("clozeSentence");
  const clozeSentenceEN = document.getElementById("clozeSentenceEN");
  const clozeChoices = document.getElementById("clozeChoices");
  const clozeNewBtn = document.getElementById("clozeNew");
  const clozeSaveWrongBtn = document.getElementById("clozeSaveWrong");
  const clozeFeedback = document.getElementById("clozeFeedback");
  let clozeState = { current:null };

  const clozeTemplates = [
    {
      ko:"í•¸ë“œí° ì‚¬ìš©ì„ ____ ë³´ë©´ ì—¬ìœ  ì‹œê°„ì´ ìƒê²¨ìš”.",
      en:"If you keep ____ phone use, you gain more free time.",
      answer:"ì¤„ì´ë‹¤",
      distractors:["ì†Œë¹„í•˜ë‹¤","ìœ ì§€í•˜ë‹¤","ë¶„ì„í•˜ë‹¤"]
    },
    {
      ko:"ìƒê°ì„ ____ ë³´ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¤„ì–´ë“¤ì–´ìš”.",
      en:"If you keep ____ your thoughts, stress decreases.",
      answer:"ì •ë¦¬í•˜ë‹¤",
      distractors:["ë“±ë¡í•˜ë‹¤","ì†Œë¹„í•˜ë‹¤","ì–´ìš¸ë¦¬ë‹¤"]
    },
    {
      ko:"ì¢‹ì€ ìŠµê´€ì„ ____ ë³´ë©´ íš¨ìœ¨ì´ ì¢‹ì•„ì ¸ìš”.",
      en:"If you keep ____ good habits, efficiency improves.",
      answer:"ì‹¤ì²œí•˜ë‹¤",
      distractors:["ë¶„ì„í•˜ë‹¤","ë“±ë¡í•˜ë‹¤","ì†Œë¹„í•˜ë‹¤"]
    }
  ];

  function newCloze(){
    const t = pick(clozeTemplates);
    clozeState.current = t;
    clozeSentence.textContent = t.ko;
    clozeSentenceEN.textContent = t.en;
    clozeFeedback.textContent = "";
    clozeChoices.innerHTML = "";

    const options = shuffle([t.answer, ...t.distractors].slice(0,4));
    options.forEach(opt=>{
      const b = document.createElement("button");
      b.className="btn";
      b.textContent=opt;
      b.addEventListener("click", ()=>{
        if(opt === t.answer){
          clozeFeedback.innerHTML = `<span class="ok">ì •ë‹µ!</span> ${escapeHtml(t.answer)}`;
        }else{
          clozeFeedback.innerHTML = `<span class="bad">í‹€ë¦¼</span> ì •ë‹µ: ${escapeHtml(t.answer)}`;
          addToSrs({
            type:"game-cloze",
            prompt:t.ko,
            user:`picked: ${opt}`,
            answer:`${t.answer}`,
            meta:"ê²Œì„/ë¹ˆì¹¸"
          });
        }
      });
      clozeChoices.appendChild(b);
    });
  }
  clozeNewBtn.addEventListener("click", newCloze);
  clozeSaveWrongBtn.addEventListener("click", ()=>{
    if(!clozeState.current){
      clozeFeedback.innerHTML = `<span class="warn">ë¨¼ì € Next ëˆŒëŸ¬ ì‹œì‘! / Press Next to start.</span>`;
      return;
    }
    addToSrs({
      type:"game-cloze",
      prompt:clozeState.current.ko,
      user:"(manual save)",
      answer:clozeState.current.answer,
      meta:"ê²Œì„/ë¹ˆì¹¸"
    });
    clozeFeedback.innerHTML = `<span class="ok">ì €ì¥ ì™„ë£Œ. / Saved.</span>`;
  });

  // Memory flip
  const memoryNewBtn = document.getElementById("memoryNew");
  const memorySaveWrongBtn = document.getElementById("memorySaveWrong");
  const memoryBoard = document.getElementById("memoryBoard");
  const memoryStats = document.getElementById("memoryStats");

  let mem = { first:null, lock:false, moves:0, matches:0, wrong:0, deck:[] };

  function buildMemoryDeck(){
    const pairs = shuffle(vocabMixed).slice(0,8); // 8 pairs
    const deck = [];
    pairs.forEach(([k,e], idx)=>{
      deck.push({ id:`k${idx}`, pair:idx, text:k, flipped:false, matched:false });
      deck.push({ id:`e${idx}`, pair:idx, text:e, flipped:false, matched:false });
    });
    return shuffle(deck);
  }

  function renderMemory(){
    memoryBoard.innerHTML = "";
    mem.deck.forEach(card=>{
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.style.height = "64px";
      btn.style.borderRadius = "14px";
      btn.style.textAlign = "center";
      btn.style.fontWeight = "800";
      btn.style.background = card.matched ? "#f0fdf4" : (card.flipped ? "#fff" : "#f1f2f7");
      btn.style.borderColor = card.matched ? "rgba(22,163,74,.35)" : "var(--line)";
      btn.textContent = (card.flipped || card.matched) ? card.text : "FLIP";
      btn.disabled = card.matched;
      btn.addEventListener("click", ()=> flipCard(card.id));
      memoryBoard.appendChild(btn);
    });
    memoryStats.innerHTML = `Moves: <b>${mem.moves}</b> â€¢ Matches: <b>${mem.matches}</b> â€¢ Wrong flips: <b>${mem.wrong}</b>`;
  }

  function flipCard(id){
    if(mem.lock) return;
    const c = mem.deck.find(x=>x.id===id);
    if(!c || c.flipped || c.matched) return;

    c.flipped = true;
    renderMemory();

    if(!mem.first){
      mem.first = c;
      return;
    }

    mem.moves++;
    if(mem.first.pair === c.pair){
      mem.first.matched = true;
      c.matched = true;
      mem.matches++;
      mem.first = null;
      renderMemory();
    } else {
      mem.wrong++;
      const first = mem.first;
      mem.lock = true;
      setTimeout(()=>{
        first.flipped = false;
        c.flipped = false;
        mem.first = null;
        mem.lock = false;
        renderMemory();
      }, 650);
    }
  }

  function newMemory(){
    mem = { first:null, lock:false, moves:0, matches:0, wrong:0, deck:buildMemoryDeck() };
    renderMemory();
  }

  memoryNewBtn.addEventListener("click", newMemory);
  memorySaveWrongBtn.addEventListener("click", ()=>{
    addToSrs({
      type:"game-memory",
      prompt:"ë©”ëª¨ë¦¬ ê²Œì„ ê²°ê³¼",
      user:`moves=${mem.moves}, wrong=${mem.wrong}, matches=${mem.matches}`,
      answer:"(aim: fewer wrong flips next time)",
      meta:"ê²Œì„/ë©”ëª¨ë¦¬"
    });
    memoryStats.innerHTML += ` â€¢ <span class="ok">Saved</span>`;
  });

  /*********************************************************
   * SRS RENDER
   *********************************************************/
  const srsList = document.getElementById("srsList");
  const srsEmpty = document.getElementById("srsEmpty");
  const refreshSrsBtn = document.getElementById("refreshSrs");
  const clearSrsBtn = document.getElementById("clearSrs");

  function renderSrs(){
    const items = loadSrs();
    srsList.innerHTML = "";
    srsEmpty.style.display = items.length ? "none" : "block";

    items.slice(0,400).forEach((it, idx)=>{
      const el = document.createElement("div");
      el.className = "item";
      const when = new Date(it.ts).toLocaleString();
      el.innerHTML = `
        <h4>${idx+1}. <span class="badge">${escapeHtml(it.meta || it.type)}</span> <span class="badge">${escapeHtml(when)}</span></h4>
        <p><b>Prompt:</b> ${escapeHtml(it.prompt || "")}</p>
        ${it.user ? `<p><b>My answer:</b> ${escapeHtml(it.user)}</p>` : ""}
        ${it.answer ? `<p><b>Answer:</b> ${escapeHtml(it.answer)}</p>` : ""}
        <div class="row">
          <button class="btn small" data-act="delete">ì‚­ì œ</button>
          <button class="btn small" data-act="copy">ë³µì‚¬</button>
        </div>
      `;
      el.querySelector('button[data-act="delete"]').addEventListener("click", ()=>{
        removeFromSrs(it.id);
        renderSrs();
      });
      el.querySelector('button[data-act="copy"]').addEventListener("click", async ()=>{
        const txt =
`[${it.meta || it.type}]
Prompt: ${it.prompt || ""}
My answer: ${it.user || ""}
Answer: ${it.answer || ""}`;
        try{
          await navigator.clipboard.writeText(txt);
          el.querySelector('button[data-act="copy"]').textContent = "ë³µì‚¬ë¨";
          setTimeout(()=>el.querySelector('button[data-act="copy"]').textContent="ë³µì‚¬", 900);
        }catch{
          el.querySelector('button[data-act="copy"]').textContent = "ì‹¤íŒ¨";
          setTimeout(()=>el.querySelector('button[data-act="copy"]').textContent="ë³µì‚¬", 900);
        }
      });

      srsList.appendChild(el);
    });
  }

  refreshSrsBtn.addEventListener("click", renderSrs);
  clearSrsBtn.addEventListener("click", ()=>{
    saveSrs([]);
    renderSrs();
  });

  /*********************************************************
   * SETTINGS TAB
   *********************************************************/
  const lessonLabelInput = document.getElementById("lessonLabelInput");
  const grammarInput = document.getElementById("grammarInput");
  const saveLessonLabelBtn = document.getElementById("saveLessonLabel");
  const resetLessonLabelBtn = document.getElementById("resetLessonLabel");
  const saveGrammarBtn = document.getElementById("saveGrammar");
  const resetGrammarBtn = document.getElementById("resetGrammar");
  const collapseAllAnswersBtn = document.getElementById("collapseAllAnswers");
  const expandAllAnswersBtn = document.getElementById("expandAllAnswers");
  const resetAllBtn = document.getElementById("resetAll");

  function syncSettingsInputs(){
    lessonLabelInput.value = CFG.lessonLabel;
    grammarInput.value = CFG.grammarTarget;
  }

  saveLessonLabelBtn.addEventListener("click", ()=>{
    CFG.lessonLabel = lessonLabelInput.value.trim() || DEFAULT_CFG.lessonLabel;
    saveCfg(CFG);
    applyCfg();
    saveLessonLabelBtn.textContent = "ì €ì¥ë¨";
    setTimeout(()=>saveLessonLabelBtn.textContent="ì €ì¥", 900);
  });

  resetLessonLabelBtn.addEventListener("click", ()=>{
    CFG.lessonLabel = DEFAULT_CFG.lessonLabel;
    saveCfg(CFG);
    applyCfg();
    syncSettingsInputs();
  });

  saveGrammarBtn.addEventListener("click", ()=>{
    CFG.grammarTarget = grammarInput.value.trim() || DEFAULT_CFG.grammarTarget;
    saveCfg(CFG);
    applyCfg();
    renderTranslations();
    if(generatedCurrent) generateTranslation();
    saveGrammarBtn.textContent = "ì €ì¥ë¨";
    setTimeout(()=>saveGrammarBtn.textContent="ì €ì¥", 900);
  });

  resetGrammarBtn.addEventListener("click", ()=>{
    CFG.grammarTarget = DEFAULT_CFG.grammarTarget;
    saveCfg(CFG);
    applyCfg();
    syncSettingsInputs();
    renderTranslations();
    if(generatedCurrent) generateTranslation();
  });

  collapseAllAnswersBtn.addEventListener("click", ()=>{
    document.querySelectorAll("#translationList details.ansDetails").forEach(d => d.removeAttribute("open"));
  });
  expandAllAnswersBtn.addEventListener("click", ()=>{
    document.querySelectorAll("#translationList details.ansDetails").forEach(d => d.setAttribute("open",""));
  });

  resetAllBtn.addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE.SRS_KEY);
    localStorage.removeItem(STORAGE.CFG_KEY);
    localStorage.removeItem(STORAGE.PICKED_KEY);
    CFG = {...DEFAULT_CFG};
    applyCfg();
    syncSettingsInputs();
    generatedHistory = [];
    generatedCurrent = null;
    renderTranslations();
    renderSrs();
    showPickedWords();
  });

  /*********************************************************
   * INIT
   *********************************************************/
  function init(){
    rebuildVocabMixed();
    applyCfg();
    syncSettingsInputs();
    renderVocabPreview(vocabMixed);
    renderWarmup();
    showPickedWords();

    // Translation
    generateTranslation();
    generatedHistory.unshift({ level:"Generated", en: genEN.textContent, ko: genModelKO.textContent });
    generatedHistory = generatedHistory.slice(0,30);
    renderTranslations();

    // Reading
    renderStory();

    // Games
    newRapid();
    newCloze();
    newMemory();
  }

  init();
</script>
</body>
</html>
