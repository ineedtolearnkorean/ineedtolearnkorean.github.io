<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ì—… ë³µìŠµ</title>
  <style>
    :root{
      --bg:#0b0b10;
      --card:#12121a;
      --card2:#161622;
      --text:#f2f2f7;
      --muted:#b8b8c6;
      --line:#262638;
      --accent:#8b5cf6;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg, #09090f, #0b0b10 40%, #07070c);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background:rgba(11,11,16,.92);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    header h1{margin:0;font-size:18px;letter-spacing:.2px}
    header .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      font-size:12px;
      color:var(--muted);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 50px;}
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 14px;
    }
    .tabBtn{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tabBtn.active{
      border-color:rgba(139,92,246,.6);
      box-shadow:0 0 0 3px rgba(139,92,246,.15);
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){
      .grid.two{grid-template-columns:1.2fr .8fr;}
    }
    .sectionTitle{font-size:16px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}
    .pill{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid var(--line);
      background:rgba(139,92,246,.10);
      padding:10px 12px;
      border-radius:14px;
      margin:10px 0 0;
      font-size:13px;
      line-height:1.4;
    }
    .pill strong{color:#e9ddff}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.02);
    }
    .item h4{margin:0 0 6px;font-size:14px;font-weight:650}
    .item p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.45}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .btn.small{padding:7px 9px;font-size:12px;border-radius:10px}
    .btn.primary{
      border-color:rgba(34,197,94,.55);
      box-shadow:0 0 0 3px rgba(34,197,94,.12);
    }
    .btn.danger{
      border-color:rgba(239,68,68,.55);
      box-shadow:0 0 0 3px rgba(239,68,68,.10);
    }
    .btn.ghost{
      background:transparent;
    }
    details summary{
      cursor:pointer;
      color:#e9ddff;
      font-size:13px;
      list-style:none;
      user-select:none;
    }
    details summary::-webkit-details-marker{display:none}
    details .answer{
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      background:rgba(139,92,246,.10);
      border:1px solid rgba(139,92,246,.22);
      font-size:13px;
      line-height:1.45;
    }
    textarea,input[type="text"]{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    textarea{min-height:96px;resize:vertical}
    .statusLine{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
    }
    .ok{color:#bbf7d0}
    .bad{color:#fecaca}
    .warn{color:#fde68a}
    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--line);
      border-radius:8px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .tiny{font-size:12px;color:var(--muted)}
    .sectionDesc{margin:0 0 8px;color:var(--muted);font-size:13px}
    .split{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .select{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      outline:none;
    }
  </style>
</head>

<body>
<header>
  <h1>ìˆ˜ì—… ë³µìŠµ</h1>
  <div class="sub">
    <span class="badge" id="badgeLesson">Lesson: 2.4 & 2.11</span>
    <span class="badge" id="badgeGrammar">Target: ~ë‹¤ ë³´ë©´</span>
    <span class="badge">Flow: ì›Œë°ì—… â†’ ë²ˆì—­ â†’ ë¬¸ì¥ â†’ SRS</span>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tabBtn active" data-tab="warmup">ë‹¨ì–´ ì›Œë°ì—…</button>
    <button class="tabBtn" data-tab="translate">ë²ˆì—­ ì—°ìŠµ</button>
    <button class="tabBtn" data-tab="builder">ë¬¸ì¥ ë§Œë“¤ê¸°</button>
    <button class="tabBtn" data-tab="srs">í‹€ë¦° ê²ƒ ë³µìŠµ (SRS)</button>
    <button class="tabBtn" data-tab="settings">ì˜µì…˜</button>
  </div>

  <!-- TAB: Warm-up -->
  <section id="tab-warmup" class="tab">
    <div class="grid two">
      <div class="card">
        <div class="split">
          <div>
            <h3 class="sectionTitle">ğŸ§  ë‹¨ì–´ ì›Œë°ì—…</h3>
            <p class="sectionDesc">ë¨¼ì € ë‹¨ì–´ â€œì–¼êµ´ ìµíˆê¸°â€ + ê°€ë²¼ìš´ ì„ íƒ ë¬¸ì œ</p>
          </div>
          <div class="tiny">
            ë‹¨ì¶•í‚¤: <span class="kbd">1</span> ì›Œë°ì—… / <span class="kbd">2</span> ë²ˆì—­ / <span class="kbd">3</span> ë¬¸ì¥ / <span class="kbd">4</span> SRS
          </div>
        </div>

        <div class="pill">
          <div>
            <strong>Tip</strong><br>
            ì—¬ê¸°ì„œëŠ” â€œì™„ë²½ ì•”ê¸°â€ ê¸ˆì§€. ê·¸ëƒ¥ <b>ì¸ì§€</b>ë§Œ í•˜ê³  ë‹¤ìŒ íƒ­ìœ¼ë¡œ ê°€ë©´ ë¨.
          </div>
        </div>

        <hr>

        <div class="list" id="warmupList"></div>
      </div>

      <div class="card">
        <h3 class="sectionTitle">ğŸ“Œ ì˜¤ëŠ˜ì˜ ë‹¨ì–´</h3>
        <p class="muted">Lesson Word Bank + Knowt Review (ì„ì–´ì„œ ë³´ì—¬ì¤˜ìš”)</p>
        <hr>
        <div id="vocabPreview" class="muted"></div>
        <div class="row">
          <button class="btn small" id="shuffleVocab">ë‹¨ì–´ ì„ê¸°</button>
          <button class="btn small" id="copyVocab">ë‹¨ì–´ ë³µì‚¬</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: Translation Practice -->
  <section id="tab-translate" class="tab" style="display:none;">
    <div class="card">
      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸŒ‰ ë²ˆì—­ ì—°ìŠµ</h3>
          <p class="sectionDesc">ì˜ì–´ â†’ í•œêµ­ì–´. ëª©í‘œ ë¬¸ë²• <b id="grammarInline">~ë‹¤ ë³´ë©´</b>ì€ ê¼­ í¬í•¨.</p>
        </div>
        <div>
          <select id="filterLevel" class="select" aria-label="filter">
            <option value="ALL">ì „ì²´</option>
            <option value="Warm-up">Warm-up</option>
            <option value="Core">Core</option>
            <option value="Challenge">Challenge</option>
          </select>
        </div>
      </div>

      <div class="pill">
        <div>
          <strong>Meaning</strong><br>
          If you keep doing X, Y naturally happens.
        </div>
      </div>

      <hr>

      <div class="list" id="translationList"></div>
      <p class="muted" id="translationCount"></p>
    </div>
  </section>

  <!-- TAB: Sentence Builder -->
  <section id="tab-builder" class="tab" style="display:none;">
    <div class="card">
      <h3 class="sectionTitle">âœï¸ ë¬¸ì¥ ë§Œë“¤ê¸°</h3>
      <p class="sectionDesc">
        ëª©í‘œ: <b id="grammarInline2">~ë‹¤ ë³´ë©´</b> + ë‹¨ì–´ <b>3ê°œ ì´ìƒ</b> í¬í•¨í•´ì„œ ë‚´ ë¬¸ì¥ ë§Œë“¤ê¸°.
        (ì›Œë°ì—…/ë²ˆì—­ì„ í•˜ê³  ì˜¤ë©´ í›¨ì”¬ ì‰¬ì›€)
      </p>

      <hr>

      <div class="item">
        <h4>í…œí”Œë¦¿</h4>
        <p class="muted">Xí•˜ë‹¤ ë³´ë©´ Y(ì´/ê°€) ë‹¬ë¼ì ¸ìš” / ìƒê²¨ìš” / ì¢‹ì•„ì ¸ìš” / ëŠ˜ì–´ìš”</p>
        <div class="row">
          <button class="btn small" id="insertTemplate">í…œí”Œë¦¿ ë„£ê¸°</button>
          <button class="btn small" id="insertIdea">ëœë¤ ì•„ì´ë””ì–´</button>
        </div>
        <p class="tiny" id="ideaLine"></p>
      </div>

      <div class="item">
        <h4>ë‚´ ë¬¸ì¥</h4>
        <textarea id="userSentence" placeholder="ì—¬ê¸°ì— ë¬¸ì¥ì„ ì¨ë³´ì„¸ìš”."></textarea>
        <div class="row">
          <button class="btn primary" id="checkSentence">Check</button>
          <button class="btn danger" id="markSentenceWrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          <button class="btn" id="clearSentence">ì§€ìš°ê¸°</button>
        </div>
        <div class="statusLine" id="sentenceFeedback"></div>
      </div>

      <div class="item">
        <h4>ë¬¸ì¥ ì²´í¬ ê·œì¹™(ìë™)</h4>
        <p class="muted">
          â€¢ ë¬¸ë²• í¬í•¨: <b>~ë‹¤ ë³´ë©´</b><br>
          â€¢ ë‹¨ì–´ 3ê°œ ì´ìƒ í¬í•¨(ì˜¤ëŠ˜ ë‹¨ì–´ ëª©ë¡ ê¸°ì¤€)<br>
          â€¢ í‹€ë¦¼ ì €ì¥í•˜ë©´ SRS íƒ­ì—ì„œ ë°˜ë³µ
        </p>
      </div>
    </div>
  </section>

  <!-- TAB: SRS -->
  <section id="tab-srs" class="tab" style="display:none;">
    <div class="card">
      <div class="split">
        <div>
          <h3 class="sectionTitle">ğŸ” í‹€ë¦° ê²ƒ ë³µìŠµ (SRS)</h3>
          <p class="sectionDesc">í‹€ë¦° í•­ëª©ë§Œ ëª¨ì•„ì„œ ë°˜ë³µ (ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨)</p>
        </div>
        <div class="row" style="margin:0;">
          <button class="btn" id="refreshSrs">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn danger" id="clearSrs">ì „ì²´ ì‚­ì œ</button>
        </div>
      </div>

      <hr>

      <div class="list" id="srsList"></div>
      <p class="muted" id="srsEmpty" style="display:none;">ì•„ì§ ì €ì¥ëœ í•­ëª©ì´ ì—†ì–´ìš”.</p>
    </div>
  </section>

  <!-- TAB: Settings / Options -->
  <section id="tab-settings" class="tab" style="display:none;">
    <div class="card">
      <h3 class="sectionTitle">âš™ï¸ ì˜µì…˜</h3>
      <p class="sectionDesc">ìŠ¤í¬ë¦°ìƒ·ì—ì„œ ë§í•œ â€œì˜µì…˜ ì—…ë°ì´íŠ¸â€ ë°˜ì˜ìš©. ì—¬ê¸°ì„œ ì„¤ì • ë°”ê¾¸ë©´ í™”ë©´ì— ë°”ë¡œ ì ìš©ë¼ìš”.</p>

      <hr>

      <div class="item">
        <h4>ë ˆìŠ¨ ë¼ë²¨</h4>
        <p class="muted">í™ˆ/ìƒë‹¨ ë°°ì§€ì— í‘œì‹œë˜ëŠ” ë ˆìŠ¨ ì´ë¦„</p>
        <input id="lessonLabelInput" type="text" value="Lesson: 2.4 & 2.11" />
        <div class="row">
          <button class="btn primary" id="saveLessonLabel">ì €ì¥</button>
          <button class="btn" id="resetLessonLabel">ê¸°ë³¸ê°’</button>
        </div>
      </div>

      <div class="item">
        <h4>ëª©í‘œ ë¬¸ë²•</h4>
        <p class="muted">ìƒë‹¨ ë°°ì§€ + ë²ˆì—­/ë¬¸ì¥ íƒ­ ê·œì¹™ì— ì ìš©</p>
        <input id="grammarInput" type="text" value="~ë‹¤ ë³´ë©´" />
        <div class="row">
          <button class="btn primary" id="saveGrammar">ì €ì¥</button>
          <button class="btn" id="resetGrammar">ê¸°ë³¸ê°’</button>
        </div>
        <p class="tiny">ì˜ˆ: ~ë”ë‹ˆ / ~(ìœ¼)ã„¹ ë•Œ / ~ê²Œ ë˜ë‹¤ / ~(ìœ¼)ë ¤ë‹¤(ê°€) ë“±ìœ¼ë¡œ ë°”ê¿”ë„ ë¨</p>
      </div>

      <div class="item">
        <h4>ë²ˆì—­ ì—°ìŠµ í‘œì‹œ ì˜µì…˜</h4>
        <p class="muted">ì •ë‹µì„ ê¸°ë³¸ìœ¼ë¡œ ìˆ¨ê¸¸ì§€(í† ê¸€ë¡œ ë³´ê¸°)</p>
        <div class="row">
          <button class="btn" id="collapseAllAnswers">ì •ë‹µ ì „ë¶€ ì ‘ê¸°</button>
          <button class="btn" id="expandAllAnswers">ì •ë‹µ ì „ë¶€ í¼ì¹˜ê¸°</button>
        </div>
      </div>

      <div class="item">
        <h4>ë°ì´í„° ì´ˆê¸°í™”</h4>
        <p class="muted">SRS/ì˜µì…˜ ì €ì¥ê°’ì„ ë¦¬ì…‹</p>
        <div class="row">
          <button class="btn danger" id="resetAll">ì „ë¶€ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
  /*********************************************************
   * CONFIG + STORAGE
   *********************************************************/
  const STORAGE = {
    SRS_KEY: "korean_srs_items_v2",
    CFG_KEY: "korean_cfg_v2"
  };

  const DEFAULT_CFG = {
    lessonLabel: "Lesson: 2.4 & 2.11",
    grammarTarget: "~ë‹¤ ë³´ë©´"
  };

  function loadCfg(){
    try{
      const raw = localStorage.getItem(STORAGE.CFG_KEY);
      if(!raw) return {...DEFAULT_CFG};
      const parsed = JSON.parse(raw);
      return {...DEFAULT_CFG, ...parsed};
    }catch{
      return {...DEFAULT_CFG};
    }
  }
  function saveCfg(cfg){
    localStorage.setItem(STORAGE.CFG_KEY, JSON.stringify(cfg));
  }

  let CFG = loadCfg();

  /*********************************************************
   * DATA (EDIT THIS SECTION ANYTIME)
   * - Add your Knowt words here as you want.
   * - You can expand to all 47/54/etc.
   *********************************************************/
  const lessonWordBank = [
    ["ì‹¤ì²œí•˜ë‹¤", "to put into practice"],
    ["ìŠµê´€", "habit"],
    ["ìœ ì§€í•˜ë‹¤", "to maintain"],
    ["ë¶„ì„í•˜ë‹¤", "to analyze"],
    ["íš¨ìœ¨", "efficiency"],
    ["ìƒíƒœ", "condition/state"],
    ["ëª©í‘œ", "goal"],
    ["ì–´ìš¸ë¦¬ë‹¤", "to suit / match"],
    ["ë¿ì´ë‹¤", "only / nothing but"]
  ];

  // Sample Knowt review words (add the rest of your set here)
  const knowtReview = [
    ["ì•„ì´ëŸ¬ë‹ˆí•˜ê²Œë„", "ironically"],
    ["ìƒì‚°ì ì´ë‹¤", "productive"],
    ["ë³´ìƒ", "reward/compensation"],
    ["ìê¸°ê³„ë°œ", "self-development"],
    ["í™•ì‹¤í•˜ë‹¤", "to be certain"],
    ["ì—´ì •", "passion"],
    ["í‰ìƒ", "lifetime"],
    ["ê´€ì ", "perspective"],
    ["ê¸°íšŒ", "opportunity"],
    ["ì•Œì•„ì°¨ë¦¬ë‹¤", "to realize"],
    ["ìƒê°ì„ ì •ë¦¬í•˜ë‹¤", "to organize thoughts"],
    ["ì‹ ê²½ì„ ì“°ë‹¤", "to worry about"],
    ["ë“±ë¡í•˜ë‹¤", "to register"],
    ["ë³µì¡í•˜ë‹¤", "to be complicated"],
    ["ì†Œë¹„í•˜ë‹¤", "to consume"]
  ];

  // Warm-up multiple choice (recognition)
  const warmupQs = [
    {
      q: "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë©´ ìƒê°ì„ ______ ìˆ˜ ìˆì–´ìš”.",
      choices: ["ì†Œë¹„í•˜ë‹¤", "ì •ë¦¬í•˜ë‹¤", "ë“±ë¡í•˜ë‹¤"],
      a: 1,
      note: "ì •ë¦¬í•˜ë‹¤ = to organize"
    },
    {
      q: "ìê¸°ê³„ë°œì„ í•˜ë©´ ìƒˆë¡œìš´ ______ê°€ ìƒê²¨ìš”.",
      choices: ["ê¸°íšŒ", "ìƒíƒœ", "íš¨ìœ¨"],
      a: 0,
      note: "ê¸°íšŒ = opportunity"
    },
    {
      q: "ì—´ì •ì„ ë”°ë¼ê°€ë©´ ëª©í‘œê°€ ë” ______ì ¸ìš”.",
      choices: ["ë³µì¡í•´", "í™•ì‹¤í•´", "ì–´ìš¸ë ¤"],
      a: 1,
      note: "í™•ì‹¤í•˜ë‹¤ â†’ í™•ì‹¤í•´ì§€ë‹¤"
    }
  ];

  // Translation items (Bridge Practice)
  // NOTE: These are written for "~ë‹¤ ë³´ë©´" but will still display if you change grammar in options.
  const translationItems = [
    // Warm-up
    { level:"Warm-up", en:"If you keep organizing your thoughts, stress decreases.",
      ko:"ìƒê°ì„ ì •ë¦¬í•˜ë‹¤ ë³´ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¤„ì–´ë“¤ì–´ìš”." },
    { level:"Warm-up", en:"If you keep working productively, you get rewarded.",
      ko:"ìƒì‚°ì ìœ¼ë¡œ ì¼í•˜ë‹¤ ë³´ë©´ ë³´ìƒì„ ë°›ê²Œ ë¼ìš”." },
    { level:"Warm-up", en:"If you keep doing self-development, new opportunities appear.",
      ko:"ìê¸°ê³„ë°œì„ ê³„ì†í•˜ë‹¤ ë³´ë©´ ìƒˆë¡œìš´ ê¸°íšŒê°€ ìƒê²¨ìš”." },
    { level:"Warm-up", en:"If you keep analyzing situations, your perspective changes.",
      ko:"ìƒí™©ì„ ê³„ì† ë¶„ì„í•˜ë‹¤ ë³´ë©´ ê´€ì ì´ ë‹¬ë¼ì ¸ìš”." },

    // Core
    { level:"Core", en:"If you keep following your passion, your life changes.",
      ko:"ì—´ì •ì„ ë”°ë¼ê°€ë‹¤ ë³´ë©´ ì‚¶ì´ ë‹¬ë¼ì ¸ìš”." },
    { level:"Core", en:"If you keep worrying about small things, life becomes complicated.",
      ko:"ì‘ì€ ì¼ì— ê³„ì† ì‹ ê²½ì„ ì“°ë‹¤ ë³´ë©´ ì‚¶ì´ ë³µì¡í•´ì ¸ìš”." },
    { level:"Core", en:"If you keep studying every day, studying becomes a habit.",
      ko:"ë§¤ì¼ ê³µë¶€í•˜ë‹¤ ë³´ë©´ ê³µë¶€ê°€ ìŠµê´€ì´ ë¼ìš”." },
    { level:"Core", en:"If you keep trying, you eventually find a method that suits you.",
      ko:"ê³„ì† ì‹œë„í•˜ë‹¤ ë³´ë©´ ë‚˜ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ë°©ë²•ì„ ì°¾ê²Œ ë¼ìš”." },

    // Challenge
    { level:"Challenge", en:"If you keep working toward your goal, success becomes certain.",
      ko:"ëª©í‘œë¥¼ í–¥í•´ ê³„ì† ë…¸ë ¥í•˜ë‹¤ ë³´ë©´ ì„±ê³µì€ í™•ì‹¤í•´ì ¸ìš”." },
    { level:"Challenge", en:"If you keep practicing good habits, efficiency improves.",
      ko:"ì¢‹ì€ ìŠµê´€ì„ ê³„ì† ì‹¤ì²œí•˜ë‹¤ ë³´ë©´ íš¨ìœ¨ì´ ì¢‹ì•„ì ¸ìš”." },
    { level:"Challenge", en:"If you keep managing stress, your mindset changes.",
      ko:"ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë‹¤ ë³´ë©´ ìƒê°ì´ ë‹¬ë¼ì ¸ìš”." },
    { level:"Challenge", en:"If you keep reducing phone use, you gain more free time.",
      ko:"í•¸ë“œí° ì‚¬ìš©ì„ ì¤„ì´ë‹¤ ë³´ë©´ ì—¬ìœ  ì‹œê°„ì´ ìƒê²¨ìš”." }
  ];

  /*********************************************************
   * HELPERS
   *********************************************************/
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  /*********************************************************
   * TABS
   *********************************************************/
  const tabButtons = document.querySelectorAll(".tabBtn");
  const tabMap = {
    warmup: document.getElementById("tab-warmup"),
    translate: document.getElementById("tab-translate"),
    builder: document.getElementById("tab-builder"),
    srs: document.getElementById("tab-srs"),
    settings: document.getElementById("tab-settings")
  };

  function showTab(key){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
    Object.entries(tabMap).forEach(([k,el]) => el.style.display = (k===key ? "block" : "none"));
    if(key === "srs") renderSrs();
  }

  tabButtons.forEach(btn => btn.addEventListener("click", () => showTab(btn.dataset.tab)));

  // Keyboard shortcuts 1-5
  window.addEventListener("keydown", (e)=>{
    if (["INPUT","TEXTAREA"].includes(document.activeElement?.tagName)) return;
    if(e.key === "1") showTab("warmup");
    if(e.key === "2") showTab("translate");
    if(e.key === "3") showTab("builder");
    if(e.key === "4") showTab("srs");
    if(e.key === "5") showTab("settings");
  });

  /*********************************************************
   * HEADER + CFG APPLY
   *********************************************************/
  const badgeLesson = document.getElementById("badgeLesson");
  const badgeGrammar = document.getElementById("badgeGrammar");
  const grammarInline = document.getElementById("grammarInline");
  const grammarInline2 = document.getElementById("grammarInline2");

  function applyCfg(){
    badgeLesson.textContent = CFG.lessonLabel;
    badgeGrammar.textContent = `Target: ${CFG.grammarTarget}`;
    grammarInline.textContent = CFG.grammarTarget;
    grammarInline2.textContent = CFG.grammarTarget;
  }

  /*********************************************************
   * VOCAB PREVIEW
   *********************************************************/
  const vocabPreviewEl = document.getElementById("vocabPreview");
  const shuffleVocabBtn = document.getElementById("shuffleVocab");
  const copyVocabBtn = document.getElementById("copyVocab");

  let vocabMixed = [];
  function rebuildVocabMixed(){
    vocabMixed = [...lessonWordBank, ...knowtReview];
  }
  function renderVocabPreview(list){
    const out = list.map(([k,e]) => `â€¢ <b>${escapeHtml(k)}</b> â€” ${escapeHtml(e)}`).join("<br>");
    vocabPreviewEl.innerHTML = out;
  }

  shuffleVocabBtn.addEventListener("click", ()=>{
    renderVocabPreview(shuffle(vocabMixed));
  });
  copyVocabBtn.addEventListener("click", async ()=>{
    const txt = vocabMixed.map(([k,e]) => `${k}\t${e}`).join("\n");
    try{
      await navigator.clipboard.writeText(txt);
      copyVocabBtn.textContent = "ë³µì‚¬ë¨";
      setTimeout(()=>copyVocabBtn.textContent="ë‹¨ì–´ ë³µì‚¬", 900);
    }catch{
      copyVocabBtn.textContent = "ë³µì‚¬ ì‹¤íŒ¨";
      setTimeout(()=>copyVocabBtn.textContent="ë‹¨ì–´ ë³µì‚¬", 900);
    }
  });

  /*********************************************************
   * WARM-UP RENDER
   *********************************************************/
  const warmupList = document.getElementById("warmupList");

  function renderWarmup(){
    warmupList.innerHTML = "";
    warmupQs.forEach((qObj, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h4>Q${idx+1}. ${escapeHtml(qObj.q)}</h4>
        <div class="row">
          ${qObj.choices.map((c,i)=>`<button class="btn small" data-i="${i}">${escapeHtml(c)}</button>`).join("")}
        </div>
        <p class="muted" style="margin-top:8px;">
          <span class="badge" id="warmupBadge${idx}">ì„ íƒí•˜ì„¸ìš”</span>
          <span style="margin-left:8px;">${escapeHtml(qObj.note || "")}</span>
        </p>
      `;
      const badge = el.querySelector(`#warmupBadge${idx}`);
      el.querySelectorAll("button[data-i]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const pick = Number(b.dataset.i);
          if (pick === qObj.a){
            badge.textContent = "ì •ë‹µ";
            badge.className = "badge ok";
          } else {
            badge.textContent = "í‹€ë¦¼ â†’ SRS ì €ì¥";
            badge.className = "badge bad";
            addToSrs({
              type:"warmup",
              prompt:qObj.q,
              user:qObj.choices[pick],
              answer:qObj.choices[qObj.a],
              meta:`Q${idx+1} / ì›Œë°ì—…`
            });
          }
        });
      });
      warmupList.appendChild(el);
    });
  }

  /*********************************************************
   * TRANSLATION RENDER
   *********************************************************/
  const translationList = document.getElementById("translationList");
  const translationCount = document.getElementById("translationCount");
  const filterLevel = document.getElementById("filterLevel");

  function renderTranslations(){
    translationList.innerHTML = "";
    const lvl = filterLevel.value;
    const items = (lvl === "ALL") ? translationItems : translationItems.filter(x => x.level === lvl);

    items.forEach((it, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h4>${idx+1}. <span class="badge">${escapeHtml(it.level)}</span> ${escapeHtml(it.en)}</h4>
        <details class="ansDetails">
          <summary>ì •ë‹µ ë³´ê¸°</summary>
          <div class="answer">${escapeHtml(it.ko)}</div>
        </details>
        <div class="row">
          <button class="btn small danger" data-action="wrong">í‹€ë¦¼ìœ¼ë¡œ ì €ì¥(SRS)</button>
          <button class="btn small" data-action="copy">ì •ë‹µ ë³µì‚¬</button>
        </div>
        <p class="muted">íŒíŠ¸: ${escapeHtml(CFG.grammarTarget)} í¬í•¨</p>
      `;
      el.querySelector('button[data-action="wrong"]').addEventListener("click", ()=>{
        addToSrs({
          type:"translation",
          prompt: it.en,
          answer: it.ko,
          meta: `${it.level} / ë²ˆì—­ ì—°ìŠµ`
        });
        el.querySelector('button[data-action="wrong"]').textContent = "ì €ì¥ë¨";
      });
      el.querySelector('button[data-action="copy"]').addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(it.ko);
          el.querySelector('button[data-action="copy"]').textContent = "ë³µì‚¬ë¨";
          setTimeout(()=>el.querySelector('button[data-action="copy"]').textContent="ì •ë‹µ ë³µì‚¬", 900);
        }catch{
          el.querySelector('button[data-action="copy"]').textContent = "ì‹¤íŒ¨";
          setTimeout(()=>el.querySelector('button[data-action="copy"]').textContent="ì •ë‹µ ë³µì‚¬", 900);
        }
      });
      translationList.appendChild(el);
    });

    translationCount.textContent = `í‘œì‹œ ì¤‘: ${items.length}ê°œ`;
  }

  filterLevel.addEventListener("change", renderTranslations);

  /*********************************************************
   * SENTENCE BUILDER
   *********************************************************/
  const insertTemplateBtn = document.getElementById("insertTemplate");
  const insertIdeaBtn = document.getElementById("insertIdea");
  const userSentence = document.getElementById("userSentence");
  const checkSentenceBtn = document.getElementById("checkSentence");
  const markSentenceWrongBtn = document.getElementById("markSentenceWrong");
  const clearSentenceBtn = document.getElementById("clearSentence");
  const sentenceFeedback = document.getElementById("sentenceFeedback");
  const ideaLine = document.getElementById("ideaLine");

  // Simple idea prompts (uses your vocab themes)
  const ideaPrompts = [
    "ìê¸°ê³„ë°œ + ìŠµê´€ + ëª©í‘œë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ìƒê° ì •ë¦¬ + ìŠ¤íŠ¸ë ˆìŠ¤ + ìƒíƒœë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ì—´ì • + ê¸°íšŒ + ê´€ì ìœ¼ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ì‹ ê²½ ì“°ë‹¤ + ë³µì¡í•˜ë‹¤ + íš¨ìœ¨ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°",
    "ë¶„ì„í•˜ë‹¤ + ëª©í‘œ + í™•ì‹¤í•˜ë‹¤ë¡œ ë¬¸ì¥ ë§Œë“¤ê¸°"
  ];

  insertTemplateBtn.addEventListener("click", ()=>{
    userSentence.value = `___í•˜ë‹¤ ë³´ë©´ ___(ì´/ê°€) ë‹¬ë¼ì ¸ìš”. (${CFG.grammarTarget})`;
    userSentence.focus();
  });

  insertIdeaBtn.addEventListener("click", ()=>{
    const pick = ideaPrompts[Math.floor(Math.random()*ideaPrompts.length)];
    ideaLine.textContent = `ì•„ì´ë””ì–´: ${pick}`;
  });

  clearSentenceBtn.addEventListener("click", ()=>{
    userSentence.value = "";
    sentenceFeedback.textContent = "";
  });

  // Count vocab hits from mixed list
  function countVocabHits(sentence){
    const uniq = new Set();
    vocabMixed.forEach(([k])=>{
      if(sentence.includes(k)) uniq.add(k);
    });
    return uniq.size;
  }

  function hasGrammar(sentence){
    // Basic check: contains "ë‹¤ ë³´ë©´" OR exact grammar target string (when user changes it)
    const g = CFG.grammarTarget.trim();
    if(!g) return false;
    if(sentence.includes("ë‹¤ ë³´ë©´") || sentence.includes("ë‹¤ë³´ë©´")) return true;
    return sentence.includes(g);
  }

  checkSentenceBtn.addEventListener("click", ()=>{
    const s = userSentence.value.trim();
    if(!s){
      sentenceFeedback.innerHTML = `<span class="warn">ë¬¸ì¥ì„ ë¨¼ì € ì¨ì¤˜!</span>`;
      return;
    }
    const gOk = hasGrammar(s);
    const hits = countVocabHits(s);

    const parts = [];
    parts.push(gOk ? `<span class="ok">ë¬¸ë²• OK</span>` : `<span class="bad">ë¬¸ë²• ì—†ìŒ (${escapeHtml(CFG.grammarTarget)})</span>`);
    parts.push(hits >= 3 ? `<span class="ok">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ</span>` : `<span class="warn">ë‹¨ì–´ í¬í•¨ ${hits}ê°œ (3ê°œ ì´ìƒ)</span>`);
    sentenceFeedback.innerHTML = parts.join(" / ");
  });

  markSentenceWrongBtn.addEventListener("click", ()=>{
    const s = userSentence.value.trim();
    if(!s){
      sentenceFeedback.innerHTML = `<span class="warn">ì €ì¥í•  ë¬¸ì¥ì´ ì—†ì–´.</span>`;
      return;
    }
    addToSrs({
      type:"sentence",
      prompt:"ë‚´ ë¬¸ì¥ (ë¬¸ì¥ ë§Œë“¤ê¸°)",
      user:s,
      answer:"(ì •ë‹µ ì—†ìŒ: ë‹¤ìŒì— ë‚´ê°€ ê³ ì³ì¤„ í•­ëª©)",
      meta:"ë¬¸ì¥ ë§Œë“¤ê¸°"
    });
    sentenceFeedback.innerHTML = `<span class="ok">SRSì— ì €ì¥í–ˆì–´. â€˜í‹€ë¦° ê²ƒ ë³µìŠµâ€™ íƒ­ì—ì„œ ë‹¤ì‹œ ë³´ì.</span>`;
  });

  /*********************************************************
   * SRS (localStorage)
   *********************************************************/
  const srsList = document.getElementById("srsList");
  const srsEmpty = document.getElementById("srsEmpty");
  const refreshSrsBtn = document.getElementById("refreshSrs");
  const clearSrsBtn = document.getElementById("clearSrs");

  function loadSrs(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE.SRS_KEY) || "[]");
    } catch {
      return [];
    }
  }
  function saveSrs(items){
    localStorage.setItem(STORAGE.SRS_KEY, JSON.stringify(items));
  }
  function addToSrs(item){
    const items = loadSrs();
    items.unshift({
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random()),
      ts: Date.now(),
      ...item
    });
    saveSrs(items);
  }
  function removeFromSrs(id){
    const items = loadSrs().filter(x=>x.id!==id);
    saveSrs(items);
  }

  function renderSrs(){
    const items = loadSrs();
    srsList.innerHTML = "";
    srsEmpty.style.display = items.length ? "none" : "block";

    items.slice(0,400).forEach((it, idx)=>{
      const el = document.createElement("div");
      el.className = "item";
      const when = new Date(it.ts).toLocaleString();
      el.innerHTML = `
        <h4>${idx+1}. <span class="badge">${escapeHtml(it.meta || it.type)}</span> <span class="badge">${escapeHtml(when)}</span></h4>
        <p><b>Prompt:</b> ${escapeHtml(it.prompt || "")}</p>
        ${it.user ? `<p><b>My answer:</b> ${escapeHtml(it.user)}</p>` : ""}
        ${it.answer ? `<p><b>Answer:</b> ${escapeHtml(it.answer)}</p>` : ""}
        <div class="row">
          <button class="btn small" data-act="delete">ì‚­ì œ</button>
          <button class="btn small" data-act="copy">ë³µì‚¬</button>
        </div>
      `;
      el.querySelector('button[data-act="delete"]').addEventListener("click", ()=>{
        removeFromSrs(it.id);
        renderSrs();
      });
      el.querySelector('button[data-act="copy"]').addEventListener("click", async ()=>{
        const txt =
`[${it.meta || it.type}]
Prompt: ${it.prompt || ""}
My answer: ${it.user || ""}
Answer: ${it.answer || ""}`;
        try{
          await navigator.clipboard.writeText(txt);
          el.querySelector('button[data-act="copy"]').textContent = "ë³µì‚¬ë¨";
          setTimeout(()=>el.querySelector('button[data-act="copy"]').textContent="ë³µì‚¬", 900);
        }catch{
          el.querySelector('button[data-act="copy"]').textContent = "ì‹¤íŒ¨";
          setTimeout(()=>el.querySelector('button[data-act="copy"]').textContent="ë³µì‚¬", 900);
        }
      });

      srsList.appendChild(el);
    });
  }

  refreshSrsBtn.addEventListener("click", renderSrs);
  clearSrsBtn.addEventListener("click", ()=>{
    saveSrs([]);
    renderSrs();
  });

  /*********************************************************
   * SETTINGS TAB (ì˜µì…˜ ì—…ë°ì´íŠ¸)
   *********************************************************/
  const lessonLabelInput = document.getElementById("lessonLabelInput");
  const grammarInput = document.getElementById("grammarInput");
  const saveLessonLabelBtn = document.getElementById("saveLessonLabel");
  const resetLessonLabelBtn = document.getElementById("resetLessonLabel");
  const saveGrammarBtn = document.getElementById("saveGrammar");
  const resetGrammarBtn = document.getElementById("resetGrammar");
  const collapseAllAnswersBtn = document.getElementById("collapseAllAnswers");
  const expandAllAnswersBtn = document.getElementById("expandAllAnswers");
  const resetAllBtn = document.getElementById("resetAll");

  function syncSettingsInputs(){
    lessonLabelInput.value = CFG.lessonLabel;
    grammarInput.value = CFG.grammarTarget;
  }

  saveLessonLabelBtn.addEventListener("click", ()=>{
    CFG.lessonLabel = lessonLabelInput.value.trim() || DEFAULT_CFG.lessonLabel;
    saveCfg(CFG);
    applyCfg();
    saveLessonLabelBtn.textContent = "ì €ì¥ë¨";
    setTimeout(()=>saveLessonLabelBtn.textContent="ì €ì¥", 900);
  });

  resetLessonLabelBtn.addEventListener("click", ()=>{
    CFG.lessonLabel = DEFAULT_CFG.lessonLabel;
    saveCfg(CFG);
    applyCfg();
    syncSettingsInputs();
  });

  saveGrammarBtn.addEventListener("click", ()=>{
    CFG.grammarTarget = grammarInput.value.trim() || DEFAULT_CFG.grammarTarget;
    saveCfg(CFG);
    applyCfg();
    renderTranslations(); // update hint lines
    saveGrammarBtn.textContent = "ì €ì¥ë¨";
    setTimeout(()=>saveGrammarBtn.textContent="ì €ì¥", 900);
  });

  resetGrammarBtn.addEventListener("click", ()=>{
    CFG.grammarTarget = DEFAULT_CFG.grammarTarget;
    saveCfg(CFG);
    applyCfg();
    syncSettingsInputs();
    renderTranslations();
  });

  collapseAllAnswersBtn.addEventListener("click", ()=>{
    document.querySelectorAll("#translationList details.ansDetails").forEach(d => d.removeAttribute("open"));
  });
  expandAllAnswersBtn.addEventListener("click", ()=>{
    document.querySelectorAll("#translationList details.ansDetails").forEach(d => d.setAttribute("open",""));
  });

  resetAllBtn.addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE.SRS_KEY);
    localStorage.removeItem(STORAGE.CFG_KEY);
    CFG = {...DEFAULT_CFG};
    applyCfg();
    syncSettingsInputs();
    renderTranslations();
    renderSrs();
  });

  /*********************************************************
   * INIT
   *********************************************************/
  function init(){
    rebuildVocabMixed();
    applyCfg();
    syncSettingsInputs();
    renderVocabPreview(vocabMixed);
    renderWarmup();
    renderTranslations();
  }
  init();
</script>
</body>
</html>
